/*
@license
Webix <%= pkg.productName %> v.<%= pkg.version %>
This software is covered by Webix Trial License.
Usage without proper license is prohibited.
(c) XB Software Ltd.
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).gantt={})}(this,(function(t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,i)};function i(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}var r=function(){return(r=Object.assign||function(t){for(var e,i=1,r=arguments.length;i<r;i++)for(var n in e=arguments[i])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)},n=function(){},s=function(){function t(t,e){this.webixJet=!0,this.webix=t,this._events=[],this._subs={},this._data={},e&&e.params&&t.extend(this._data,e.params)}return t.prototype.getRoot=function(){return this._root},t.prototype.destructor=function(){this._detachEvents(),this._destroySubs(),this._events=this._container=this.app=this._parent=this._root=null},t.prototype.setParam=function(t,e,i){if(this._data[t]!==e&&(this._data[t]=e,this._segment.update(t,e,0),i))return this.show(null)},t.prototype.getParam=function(t,e){var i=this._data[t];if(void 0!==i||!e)return i;var r=this.getParentView();return r?r.getParam(t,e):void 0},t.prototype.getUrl=function(){return this._segment.suburl()},t.prototype.getUrlString=function(){return this._segment.toString()},t.prototype.getParentView=function(){return this._parent},t.prototype.$$=function(t){if("string"==typeof t){var e=this.getRoot();return e.queryView((function(i){return(i.config.id===t||i.config.localId===t)&&i.$scope===e.$scope}),"self")}return t},t.prototype.on=function(t,e,i){var r=t.attachEvent(e,i);return this._events.push({obj:t,id:r}),r},t.prototype.contains=function(t){for(var e in this._subs){var i=this._subs[e].view;if(i===t||i.contains(t))return!0}return!1},t.prototype.getSubView=function(t){var e=this.getSubViewInfo(t);if(e)return e.subview.view},t.prototype.getSubViewInfo=function(t){var e=this._subs[t||"default"];return e?{subview:e,parent:this}:"_top"===t?(this._subs[t]={url:"",id:null,popup:!0},this.getSubViewInfo(t)):this._parent?this._parent.getSubViewInfo(t):null},t.prototype._detachEvents=function(){for(var t=this._events,e=t.length-1;e>=0;e--)t[e].obj.detachEvent(t[e].id)},t.prototype._destroySubs=function(){for(var t in this._subs){var e=this._subs[t].view;e&&e.destructor()}this._subs={}},t.prototype._init_url_data=function(){var t=this._segment.current();this._data={},this.webix.extend(this._data,t.params,!0)},t.prototype._getDefaultSub=function(){if(this._subs.default)return this._subs.default;for(var t in this._subs){var e=this._subs[t];if(!e.branch&&e.view&&"_top"!==t){var i=e.view._getDefaultSub();if(i)return i}}},t.prototype._routed_view=function(){var t=this.getParentView();if(!t)return!0;var e=t._getDefaultSub();return!(!e&&e!==this)&&t._routed_view()},t}();function a(t){"/"===t[0]&&(t=t.substr(1));for(var e=t.split("/"),i=[],r=0;r<e.length;r++){var n=e[r],s={},a=n.indexOf(":");if(-1===a&&(a=n.indexOf("?")),-1!==a)for(var o=0,l=n.substr(a+1).split(/[\:\?\&]/g);o<l.length;o++){var c=l[o].split("=");s[c[0]]=decodeURIComponent(c[1])}i[r]={page:a>-1?n.substr(0,a):n,params:s,isNew:!0}}return i}function o(t){for(var e=[],i=0,r=t;i<r.length;i++){var n=r[i];e.push("/"+n.page);var s=l(n.params);s&&e.push("?"+s)}return e.join("")}function l(t){var e=[];for(var i in t)"object"!=typeof t[i]&&(e.length&&e.push("&"),e.push(i+"="+encodeURIComponent(t[i])));return e.join("")}var c=function(){function t(t,e){this._next=1,this.route="string"==typeof t?{url:a(t),path:t}:t,this.index=e}return t.prototype.current=function(){return this.route.url[this.index]},t.prototype.next=function(){return this.route.url[this.index+this._next]},t.prototype.suburl=function(){return this.route.url.slice(this.index)},t.prototype.shift=function(e){var i=new t(this.route,this.index+this._next);return i.setParams(i.route.url,e,i.index),i},t.prototype.setParams=function(t,e,i){if(e){var r=t[i].params;for(var n in e)r[n]=e[n]}},t.prototype.refresh=function(){for(var t=this.route.url,e=this.index+1;e<t.length;e++)t[e].isNew=!0},t.prototype.toString=function(){var t=o(this.suburl());return t?t.substr(1):""},t.prototype._join=function(t,e){var i=this.route.url;if(null===t)return i;var r=this.route.url,n=!0;if(i=r.slice(0,this.index+(e?this._next:0)),t){i=i.concat(a(t));for(var s=0;s<i.length;s++)r[s]&&(i[s].view=r[s].view),n&&r[s]&&i[s].page===r[s].page?i[s].isNew=!1:i[s].isNew&&(n=!1)}return i},t.prototype.append=function(t){var e=this._join(t,!0);return this.route.path=o(e),this.route.url=e,this.route.path},t.prototype.show=function(t,e,i){var r=this,s=this._join(t.url,i);return this.setParams(s,t.params,this.index+(i?this._next:0)),new Promise((function(t,i){var a=o(s),l={url:s,redirect:a,confirm:Promise.resolve()},c=e?e.app:null;if(c&&!c.callEvent("app:guard",[l.redirect,e,l]))return void i(new n);l.confirm.catch((function(t){return i(t)})).then((function(){if(null!==l.redirect){if(l.redirect!==a)return c.show(l.redirect),void i(new n);r.route.path=a,r.route.url=s,t()}else i(new n)}))}))},t.prototype.size=function(t){this._next=t},t.prototype.split=function(){var e={url:this.route.url.slice(this.index+1),path:""};return e.url.length&&(e.path=o(e.url)),new t(e,0)},t.prototype.update=function(t,e,i){var r=this.route.url[this.index+(i||0)];if(!r)return this.route.url.push({page:"",params:{}}),this.update(t,e,i);""===t?r.page=e:r.params[t]=e,this.route.path=o(this.route.url)},t}(),u=function(t){function e(e,i){var r=t.call(this,e.webix)||this;return r.app=e,r._children=[],r}return i(e,t),e.prototype.ui=function(t,e){var i=(e=e||{}).container||t.container,r=this.app.createView(t);return this._children.push(r),r.render(i,this._segment,this),"object"!=typeof t||t instanceof s?r:r.getRoot()},e.prototype.show=function(t,e){if(e=e||{},"object"==typeof t){for(var i in t)this.setParam(i,t[i]);t=null}else{if("/"===t.substr(0,1))return this.app.show(t,e);if(0===t.indexOf("./")&&(t=t.substr(2)),0===t.indexOf("../")){var r=this.getParentView();return r?r.show(t.substr(3),e):this.app.show("/"+t.substr(3))}var n=this.getSubViewInfo(e.target);if(n){if(n.parent!==this)return n.parent.show(t,e);if(e.target&&"default"!==e.target)return this._renderFrameLock(e.target,n.subview,{url:t,params:e.params})}else if(t)return this.app.show("/"+t,e)}return this._show(this._segment,{url:t,params:e.params},this)},e.prototype._show=function(t,e,i){var r=this;return t.show(e,i,!0).then((function(){return r._init_url_data(),r._urlChange()})).then((function(){t.route.linkRouter&&(r.app.getRouter().set(t.route.path,{silent:!0}),r.app.callEvent("app:route",[t.route.path]))}))},e.prototype.init=function(t,e){},e.prototype.ready=function(t,e){},e.prototype.config=function(){this.app.webix.message("View:Config is not implemented")},e.prototype.urlChange=function(t,e){},e.prototype.destroy=function(){},e.prototype.destructor=function(){this.destroy(),this._destroyKids(),this._root&&(this._root.destructor(),t.prototype.destructor.call(this))},e.prototype.use=function(t,e){t(this.app,this,e)},e.prototype.refresh=function(){this.getUrl();return this.destroy(),this._destroyKids(),this._destroySubs(),this._detachEvents(),this._container.tagName&&this._root.destructor(),this._segment.refresh(),this._render(this._segment)},e.prototype.render=function(t,e,i){var r=this;"string"==typeof e&&(e=new c(e,0)),this._segment=e,this._parent=i,this._init_url_data();var n="string"==typeof(t=t||document.body)?this.webix.toNode(t):t;return this._container!==n?(this._container=n,this._render(e)):this._urlChange().then((function(){return r.getRoot()}))},e.prototype._render=function(t){var e=this,i=this.config();return i.then?i.then((function(i){return e._render_final(i,t)})):this._render_final(i,t)},e.prototype._render_final=function(t,e){var i,r=this,n=null,s=null,a=!1;if(this._container.tagName?s=this._container:(n=this._container).popup?(s=document.body,a=!0):s=this.webix.$$(n.id),!this.app||!s)return Promise.reject(null);var o=this._segment.current(),l={ui:{}};this.app.copyConfig(t,l.ui,this._subs),this.app.callEvent("app:render",[this,e,l]),l.ui.$scope=this,!n&&o.isNew&&o.view&&o.view.destructor();try{if(n&&!a){var c=s,u=c.getParentView();u&&"multiview"===u.name&&!l.ui.id&&(l.ui.id=c.config.id)}this._root=this.app.webix.ui(l.ui,s);var h=this._root;a&&h.setPosition&&!h.isVisible()&&h.show(),n&&(n.view&&n.view!==this&&n.view!==this.app&&n.view.destructor(),n.id=this._root.config.id,this.getParentView()||!this.app.app?n.view=this:n.view=this.app),o.isNew&&(o.view=this,o.isNew=!1),i=Promise.resolve(this._init(this._root,e)).then((function(){return r._urlChange().then((function(){return r._initUrl=null,r.ready(r._root,e.suburl())}))}))}catch(t){i=Promise.reject(t)}return i.catch((function(t){return r._initError(r,t)}))},e.prototype._init=function(t,e){return this.init(t,e.suburl())},e.prototype._urlChange=function(){var t=this;this.app.callEvent("app:urlchange",[this,this._segment]);var e=[];for(var i in this._subs){var r=this._subs[i],n=this._renderFrameLock(i,r,null);n&&e.push(n)}return Promise.all(e).then((function(){return t.urlChange(t._root,t._segment.suburl())}))},e.prototype._renderFrameLock=function(t,e,i){if(!e.lock){var r=this._renderFrame(t,e,i);r&&(e.lock=r.then((function(){return e.lock=null}),(function(){return e.lock=null})))}return e.lock},e.prototype._renderFrame=function(t,e,i){var r=this;if("default"===t){if(this._segment.next()){var n=i?i.params:null;return e.params&&(n=this.webix.extend(n||{},e.params)),this._createSubView(e,this._segment.shift(n))}e.view&&e.popup&&(e.view.destructor(),e.view=null)}if(null!==i&&(e.url=i.url,e.params&&(i.params=this.webix.extend(i.params||{},e.params))),e.route){if(null!==i)return e.route.show(i,e.view).then((function(){return r._createSubView(e,e.route)}));if(e.branch)return}var s=e.view;if(!s&&e.url){if("string"==typeof e.url)return e.route=new c(e.url,0),i&&e.route.setParams(e.route.route.url,i.params,0),e.params&&e.route.setParams(e.route.route.url,e.params,0),this._createSubView(e,e.route);"function"!=typeof e.url||s instanceof e.url||(s=new(this.app._override(e.url))(this.app,"")),s||(s=e.url)}if(s)return s.render(e,e.route||this._segment,this)},e.prototype._initError=function(t,e){return this.app&&this.app.error("app:error:initview",[e,t]),!0},e.prototype._createSubView=function(t,e){var i=this;return this.app.createFromURL(e.current()).then((function(r){return r.render(t,e,i)}))},e.prototype._destroyKids=function(){for(var t=this._children,e=t.length-1;e>=0;e--)t[e]&&t[e].destructor&&t[e].destructor();this._children=[]},e}(s),h=function(t){function e(e,i){var r=t.call(this,e,i)||this;return r._ui=i.ui,r}return i(e,t),e.prototype.config=function(){return this._ui},e}(u),p=function(){function t(t,e,i){this.path="",this.app=i}return t.prototype.set=function(t,e){this.path=t;var i=this.app;i.app.getRouter().set(i._segment.append(this.path),{silent:!0})},t.prototype.get=function(){return this.path},t}(),d=!0,f=function(t){function e(e){var i=this,r=(e||{}).webix||window.webix;return e=r.extend({name:"App",version:"1.0",start:"/home"},e,!0),(i=t.call(this,r,e)||this).config=e,i.app=i.config.app,i.ready=Promise.resolve(),i._services={},i.webix.extend(i,i.webix.EventSystem),i}return i(e,t),e.prototype.getUrl=function(){return this._subSegment.suburl()},e.prototype.getUrlString=function(){return this._subSegment.toString()},e.prototype.getService=function(t){var e=this._services[t];return"function"==typeof e&&(e=this._services[t]=e(this)),e},e.prototype.setService=function(t,e){this._services[t]=e},e.prototype.destructor=function(){this.getSubView().destructor(),t.prototype.destructor.call(this)},e.prototype.copyConfig=function(t,e,i){if((t instanceof s||"function"==typeof t&&t.prototype instanceof s)&&(t={$subview:t}),void 0!==t.$subview)return this.addSubView(t,e,i);var r=t instanceof Array;for(var n in e=e||(r?[]:{}),t){var a=t[n];if("function"==typeof a&&a.prototype instanceof s&&(a={$subview:a}),!a||"object"!=typeof a||a instanceof this.webix.DataCollection||a instanceof RegExp||a instanceof Map)e[n]=a;else if(a instanceof Date)e[n]=new Date(a);else{var o=this.copyConfig(a,a instanceof Array?[]:{},i);null!==o&&(r?e.push(o):e[n]=o)}}return e},e.prototype.getRouter=function(){return this.$router},e.prototype.clickHandler=function(t,e){if(t&&(e=e||t.target||t.srcElement)&&e.getAttribute){var i=e.getAttribute("trigger");if(i)return this._forView(e,(function(t){return t.app.trigger(i)})),t.cancelBubble=!0,t.preventDefault();var r=e.getAttribute("route");if(r)return this._forView(e,(function(t){return t.show(r)})),t.cancelBubble=!0,t.preventDefault()}var n=e.parentNode;n&&this.clickHandler(t,n)},e.prototype.getRoot=function(){return this.getSubView().getRoot()},e.prototype.refresh=function(){var t=this;return this._subSegment?this.getSubView().refresh().then((function(e){return t.callEvent("app:route",[t.getUrl()]),e})):Promise.resolve(null)},e.prototype.loadView=function(t){var e=this,i=this.config.views,r=null;if(""===t)return Promise.resolve(this._loadError("",new Error("Webix Jet: Empty url segment")));try{i&&"string"==typeof(r="function"==typeof i?i(t):i[t])&&(t=r,r=null),r||("_hidden"===t?r={hidden:!0}:"_blank"===t?r={}:(t=t.replace(/\./g,"/"),r=this.require("jet-views",t)))}catch(e){r=this._loadError(t,e)}return r.then||(r=Promise.resolve(r)),r=r.then((function(t){return t.__esModule?t.default:t})).catch((function(i){return e._loadError(t,i)}))},e.prototype._forView=function(t,e){var i=this.webix.$$(t);i&&e(i.$scope)},e.prototype._loadViewDynamic=function(t){return null},e.prototype.createFromURL=function(t){var e=this;return t.isNew||!t.view?this.loadView(t.page).then((function(i){return e.createView(i,name,t.params)})):Promise.resolve(t.view)},e.prototype._override=function(t){var e=this.config.override;if(e){for(var i=void 0;t;)i=t,t=e.get(t);return i}return t},e.prototype.createView=function(t,i,r){if("function"==typeof(t=this._override(t))){if(t.prototype instanceof e)return new t({app:this,name:i,params:r,router:p});if(t.prototype instanceof s)return new t(this,{name:i,params:r});t=t(this)}return t instanceof s?t:new h(this,{name:i,ui:t})},e.prototype.show=function(t,e){return t&&this.app&&0==t.indexOf("//")?this.app.show(t.substr(1),e):this.render(this._container,t||this.config.start,e)},e.prototype.trigger=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];this.apply(t,e)},e.prototype.apply=function(t,e){this.callEvent(t,e)},e.prototype.action=function(t){return this.webix.bind((function(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];this.apply(t,e)}),this)},e.prototype.on=function(t,e){this.attachEvent(t,e)},e.prototype.use=function(t,e){t(this,null,e)},e.prototype.error=function(t,e){if(this.callEvent(t,e),this.callEvent("app:error",e),this.config.debug)for(var i=0;i<e.length;i++)if(console.error(e[i]),e[i]instanceof Error){var r=e[i].message;0===r.indexOf("Module build failed")?(r=r.replace(/\x1b\[[0-9;]*m/g,""),document.body.innerHTML="<pre style='font-size:16px; background-color: #ec6873; color: #000; padding:10px;'>"+r+"</pre>"):(r+="<br><br>Check console for more details",this.webix.message({type:"error",text:r,expire:-1}))}},e.prototype.render=function(t,e,i){var r=this;this._container="string"==typeof t?this.webix.toNode(t):t||document.body;var n=null;!this.$router?(d&&"tagName"in this._container&&(this.webix.event(document.body,"click",(function(t){return r.clickHandler(t)})),d=!1),"string"==typeof e&&(e=new c(e,0)),this._subSegment=this._first_start(e),this._subSegment.route.linkRouter=!0):n="string"==typeof e?e:this.app?e.split().route.path||this.config.start:e.toString();var s=i?i.params:this.config.params||null,a=this.getSubView(),o=this._subSegment,l=o.show({url:n,params:s},a).then((function(){return r.createFromURL(o.current())})).then((function(e){return e.render(t,o)})).then((function(t){return r.$router.set(o.route.path,{silent:!0}),r.callEvent("app:route",[r.getUrl()]),t}));return this.ready=this.ready.then((function(){return l})),l},e.prototype.getSubView=function(){if(this._subSegment){var t=this._subSegment.current().view;if(t)return t}return new u(this,{})},e.prototype.require=function(t,e){return null},e.prototype._first_start=function(t){var e=this;this._segment=t;if(this.$router=new this.config.router((function(t){return setTimeout((function(){e.show(t).catch((function(t){if(!(t instanceof n))throw t}))}),1)}),this.config,this),this._container===document.body&&!1!==this.config.animation){var i=this._container;this.webix.html.addCss(i,"webixappstart"),setTimeout((function(){e.webix.html.removeCss(i,"webixappstart"),e.webix.html.addCss(i,"webixapp")}),10)}if(t){if(this.app){var r=t.current().view;t.current().view=this,t.next()?(t.refresh(),t=t.split()):t=new c(this.config.start,0),t.current().view=r}}else{var s=this.$router.get();s||(s=this.config.start,this.$router.set(s,{silent:!0})),t=new c(s,0)}return t},e.prototype._loadError=function(t,e){return this.error("app:error:resolve",[e,t]),{template:" "}},e.prototype.addSubView=function(t,e,i){var r=!0!==t.$subview?t.$subview:null,n=t.name||(r?this.webix.uid():"default");return e.id=t.id||"s"+this.webix.uid(),(i[n]={id:e.id,url:r,branch:t.branch,popup:t.popup,params:t.params}).popup?null:e},e}(s),g=function(){function t(t,e){var i=this;this.config=e||{},this._detectPrefix(),this.cb=t,window.onpopstate=function(){return i.cb(i.get())}}return t.prototype.set=function(t,e){var i=this;if(this.config.routes){var r=t.split("?",2);for(var n in this.config.routes)if(this.config.routes[n]===r[0]){t=n+(r.length>1?"?"+r[1]:"");break}}this.get()!==t&&window.history.pushState(null,null,this.prefix+this.sufix+t),e&&e.silent||setTimeout((function(){return i.cb(t)}),1)},t.prototype.get=function(){var t=this._getRaw().replace(this.prefix,"").replace(this.sufix,"");if(t="/"!==t&&"#"!==t?t:"",this.config.routes){var e=t.split("?",2),i=this.config.routes[e[0]];i&&(t=i+(e.length>1?"?"+e[1]:""))}return t},t.prototype._detectPrefix=function(){var t=this.config.routerPrefix;this.sufix="#"+(void 0===t?"!":t),this.prefix=document.location.href.split("#",2)[0]},t.prototype._getRaw=function(){return document.location.href},t}(),v=!1;function m(t){if(!v&&t){v=!0;var e=window;e.Promise||(e.Promise=t.promise);var i=t.version.split(".");10*i[0]+1*i[1]<53&&(t.ui.freeze=function(e){var i=e();return i&&i.then?i.then((function(e){return t.ui.$freeze=!1,t.ui.resize(),e})):(t.ui.$freeze=!1,t.ui.resize()),i});var r=t.ui.baselayout.prototype.addView,n=t.ui.baselayout.prototype.removeView,s={addView:function(t,e){if(this.$scope&&this.$scope.webixJet&&!t.queryView){var i=this.$scope,n={};t=i.app.copyConfig(t,{},n),r.apply(this,[t,e]);var s=function(t){i._renderFrame(t,n[t],null).then((function(){i._subs[t]=n[t]}))};for(var a in n)s(a);return t.id}return r.apply(this,arguments)},removeView:function(){if(n.apply(this,arguments),this.$scope&&this.$scope.webixJet){var e=this.$scope._subs;for(var i in e){var r=e[i];t.$$(r.id)||(r.view.destructor(),delete e[i])}}}};t.extend(t.ui.layout.prototype,s,!0),t.extend(t.ui.baselayout.prototype,s,!0),t.protoUI({name:"jetapp",$init:function(e){this.$app=new this.app(e);var i=t.uid().toString();e.body={id:i},this.$ready.push((function(){this.callEvent("onInit",[this.$app]),this.$app.render({id:i})}))}},t.ui.proxy,t.EventSystem)}}var y=function(t){function e(e){var i;return e.router=e.router||g,m((i=t.call(this,e)||this).webix),i}return i(e,t),e.prototype.require=function(t,e){return require(t+"/"+e)},e}(f),_=(function(t){function e(){return null!==t&&t.apply(this,arguments)||this}i(e,t),e.prototype._detectPrefix=function(){this.prefix="",this.sufix=this.config.routerPrefix||""},e.prototype._getRaw=function(){return document.location.pathname+(document.location.search||"")}}(g),function(){function t(t,e){this.path="",this.cb=t}return t.prototype.set=function(t,e){var i=this;this.path=t,e&&e.silent||setTimeout((function(){return i.cb(t)}),1)},t.prototype.get=function(){return this.path},t}());function w(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function b(t,e,i){for(var r in t)w(t,r)&&e.call(i||t,t[r],r,t)}function x(t){t="Warning: "+t,"undefined"!=typeof console&&console.error(t);try{throw new Error(t)}catch(t){}}var k=String.prototype.replace,S=String.prototype.split,T=function(t){var e=t%10;return 11!==t&&1===e?0:2<=e&&e<=4&&!(t>=12&&t<=14)?1:2},$={arabic:function(t){if(t<3)return t;var e=t%100;return e>=3&&e<=10?3:e>=11?4:5},bosnian_serbian:T,chinese:function(){return 0},croatian:T,french:function(t){return t>1?1:0},german:function(t){return 1!==t?1:0},russian:T,lithuanian:function(t){return t%10==1&&t%100!=11?0:t%10>=2&&t%10<=9&&(t%100<11||t%100>19)?1:2},czech:function(t){return 1===t?0:t>=2&&t<=4?1:2},polish:function(t){if(1===t)return 0;var e=t%10;return 2<=e&&e<=4&&(t%100<10||t%100>=20)?1:2},icelandic:function(t){return t%10!=1||t%100==11?1:0},slovenian:function(t){var e=t%100;return 1===e?0:2===e?1:3===e||4===e?2:3}},C={arabic:["ar"],bosnian_serbian:["bs-Latn-BA","bs-Cyrl-BA","srl-RS","sr-RS"],chinese:["id","id-ID","ja","ko","ko-KR","lo","ms","th","th-TH","zh"],croatian:["hr","hr-HR"],german:["fa","da","de","en","es","fi","el","he","hi-IN","hu","hu-HU","it","nl","no","pt","sv","tr"],french:["fr","tl","pt-br"],russian:["ru","ru-RU"],lithuanian:["lt"],czech:["cs","cs-CZ","sk"],polish:["pl"],icelandic:["is"],slovenian:["sl-SL"]};function D(t){var e,i=(e={},b(C,(function(t,i){b(t,(function(t){e[t]=i}))})),e);return i[t]||i[S.call(t,/-/,1)[0]]||i.en}function R(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var I=/\$/g,H=/%\{(.*?)\}/g;function L(t,e,i,r){if("string"!=typeof t)throw new TypeError("Polyglot.transformPhrase expects argument #1 to be string");if(null==e)return t;var n=t,s=r||H,a="number"==typeof e?{smart_count:e}:e;if(null!=a.smart_count&&n){var o=S.call(n,"||||");n=(o[function(t,e){return $[D(t)](e)}(i||"en",a.smart_count)]||o[0]).replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}return n=k.call(n,s,(function(t,e){return w(a,e)&&null!=a[e]?k.call(a[e],I,"$$"):t}))}function P(t){var e=t||{};this.phrases={},this.extend(e.phrases||{}),this.currentLocale=e.locale||"en";var i=e.allowMissing?L:null;this.onMissingKey="function"==typeof e.onMissingKey?e.onMissingKey:i,this.warn=e.warn||x,this.tokenRegex=function(t){var e=t&&t.prefix||"%{",i=t&&t.suffix||"}";if("||||"===e||"||||"===i)throw new RangeError('"||||" token is reserved for pluralization');return new RegExp(R(e)+"(.*?)"+R(i),"g")}(e.interpolation)}P.prototype.locale=function(t){return t&&(this.currentLocale=t),this.currentLocale},P.prototype.extend=function(t,e){b(t,(function(t,i){var r=e?e+"."+i:i;"object"==typeof t?this.extend(t,r):this.phrases[r]=t}),this)},P.prototype.unset=function(t,e){"string"==typeof t?delete this.phrases[t]:b(t,(function(t,i){var r=e?e+"."+i:i;"object"==typeof t?this.unset(t,r):delete this.phrases[r]}),this)},P.prototype.clear=function(){this.phrases={}},P.prototype.replace=function(t){this.clear(),this.extend(t)},P.prototype.t=function(t,e){var i,r,n=null==e?{}:e;if("string"==typeof this.phrases[t])i=this.phrases[t];else if("string"==typeof n._)i=n._;else if(this.onMissingKey){r=(0,this.onMissingKey)(t,n,this.currentLocale,this.tokenRegex)}else this.warn('Missing translation for key: "'+t+'"'),r=t;return"string"==typeof i&&(r=L(i,n,this.currentLocale,this.tokenRegex)),r},P.prototype.has=function(t){return w(this.phrases,t)},P.transformPhrase=function(t,e,i){return L(t,e,i)};var A=P;var E=window.webix;E&&m(E);var M=function(t,e,i){var r=(i=i||{}).storage,n=r?r.get("lang")||"en":i.lang||"en";function s(e,s,a){s.__esModule&&(s=s.default);var l={phrases:s};i.polyglot&&t.webix.extend(l,i.polyglot);var c=o.polyglot=new A(l);if(c.locale(e),o._=t.webix.bind(c.t,c),n=e,r&&r.put("lang",n),i.webix){var u=i.webix[e];u&&t.webix.i18n.setLocale(u)}return a?Promise.resolve():t.refresh()}function a(e,r){if(!1!==i.path){var n=(i.path?i.path+"/":"")+e;s(e,t.require("jet-locales",n),r)}}var o={getLang:function(){return n},setLang:a,setLangData:s,_:null,polyglot:null};t.setService("locale",o),a(n,!0)},U=window;U.Promise||(U.Promise=U.webix.promise);var B=1;function j(t,e,i){Object.defineProperty(e,i,{get:function(){return t[i]},set:function(e){return t[i]=e}})}function V(t,e){e=e||{};var i={},r={},n=function(t,e){var n=B++;return i[n]={mask:t,handler:e},e("*"===t?r:r[t],void 0,t),n},s=[],a=!1,o=function(t,e,r,n){if(a)s.push([t,e,r,n]);else for(var o=Object.keys(i),l=0;l<o.length;l++){var c=i[o[l]];c&&("*"!==c.mask&&c.mask!==t||c.handler(r,e,t,n))}};return Object.defineProperty(r,"$changes",{value:{attachEvent:n,detachEvent:function(t){delete i[t]}},enumerable:!1,configurable:!1}),Object.defineProperty(r,"$observe",{value:n,enumerable:!1,configurable:!1}),Object.defineProperty(r,"$batch",{value:function(t){if("function"!=typeof t){var e=t;t=function(){for(var t in e)r[t]=e[t]}}for(a=!0,t(r),a=!1;s.length;){var i=s.shift();o.apply(this,i)}},enumerable:!1,configurable:!1}),Object.defineProperty(r,"$extend",{value:function(t,i){for(var n in i=i||e,t)if(t.hasOwnProperty(n)){var s=t[n];i.nested&&"object"==typeof s&&s?r[n]=V(s,i):O(r,s,n,o)}},enumerable:!1,configurable:!1}),r.$extend(t,e),r}function O(t,e,i,r){Object.defineProperty(t,i,{get:function(){return e},set:function(t){if(null===e||null===t?e!==t:e.valueOf()!=t.valueOf()){var n=e;e=t,r(i,n,t,null)}},enumerable:!0,configurable:!1})}var F={start:function(t,e){t._auto_scroll_delay=webix.delay(F.autoScroll,t,[e,webix.html.pos(e)],250)},reset:function(t){t._auto_scroll_delay&&(t._auto_scroll_delay=window.clearTimeout(t._auto_scroll_delay))},autoScroll:function(t,e){var i=-1!==this.direction.indexOf("y"),r=-1!==this.direction.indexOf("x"),n=webix.html.offset(this.from.$view),s=!1;i&&F.autoYScroll.call(this,e,n,this.senseY)&&(s=!0),r&&F.autoXScroll.call(this,e,n,this.senseX)&&(s=!0),s&&(!function(t,e){if(webix.DragControl.active){var i=webix.DragControl.getNode();e=webix.copy(e),webix.DragControl.$dragPos(e,t),i.style.top=e.y+webix.DragControl.top+"px",i.style.left=e.x+webix.DragControl.left+"px"}}(t,e),this._auto_scroll_delay=webix.delay(F.autoScroll,this,[t,e],100))},autoYScroll:function(t,e,i){var r=this.from.getScrollState();return t.y<e.y+i?F.autoScrollTo.call(this,r.x,r.y-i,"y"):t.y>e.y+e.height-i&&F.autoScrollTo.call(this,r.x,r.y+i,"y")},autoXScroll:function(t,e,i){var r=this.from.getScrollState();if(t.x<e.x+i)return F.autoScrollTo.call(this,r.x-i,r.y,"x");if(t.x>e.x+e.width-i){var n=this.snode?Math.min(r.x+i,this.snode.scrollWidth-e.width):r.x+i;return n!=r.x&&F.autoScrollTo.call(this,n,r.y,"x")}return!1},autoScrollTo:function(t,e,i){this.from.scrollTo(t,e),this.from.callEvent("onAfterAutoScroll",[]);var r=this.from.getScrollState();return Math.abs(("x"===i?t:e)-r[i])<1}};var W,z=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var i=webix.Date;function r(t,e){return i.add(t,1*e,"day",!0)}function n(t,e){return(t=new Date(t)).setHours(0,0,0,0),(e=new Date(e)).setHours(0,0,0,0),Math.round((t.getTime()-e.getTime())/864e5)}function s(t,e){return 24*n(t,e)+(t.getHours()-e.getHours())}var a={};function o(t,e){return l(e)(t)}function l(t){var e=a[t];return e||(e=a[t]=i.dateToStr(t)),e}function c(t){var e=t.getDay();return i.startOnMonday&&(0===e?e=6:e--),e}var u={year:function(t,e){return t.getFullYear()-e.getFullYear()},quarter:function(t,e){return 4*(t.getFullYear()-e.getFullYear())+(Math.floor(t.getMonth()/3)+1)-(Math.floor(e.getMonth()/3)+1)},month:function(t,e){return 12*(t.getFullYear()-e.getFullYear())+(t.getMonth()-e.getMonth())},week:function(t,e){var i=n(t,e)/7,r=c(t),s=c(e);return Math.ceil(Math.abs(i)-(r<=s?0:1))*Math.sign(i)},day:n,hour:s,minute:function(t,e){return 60*s(t,e)+(t.getMinutes()-e.getMinutes())}};var h={year:["quarter",4],quarter:["month",3],month:["day",function(t){if(!t)return 30;var e=t.getMonth();if(1===e){var i=t.getFullYear();return i%4?28:i%100?29:i%400?28:29}return e%2&&e<7||!(e%2)&&e>7?30:31}],week:["day",7],day:["hour",24],hour:["minute",60]},p={year:function(t,e){return i.add(t,1*e,"year",!0)},quarter:function(t,e){return i.add(t,3*e,"month",!0)},month:function(t,e){return i.add(t,1*e,"month",!0)},week:function(t,e){return i.add(t,1*e,"week",!0)},day:r,hour:function(t,e){return i.add(t,1*e,"hour",!0)},minute:function(t,e){return i.add(t,1*e,"minute",!0)}};function d(t,e,i,r,n){var s=r?h[t][0]:t,a=i,o=e;if(n&&(a=m(s,i),(o=m(s,e))<e&&(o=v(s)(o,1))),r){var l=u[s](o,a),c=h[t][1];return l/("number"==typeof c?c:c(i))}return u[s](o,a)}function f(t){return function(e,i,r,n){return"month"===t&&r?function(t,e,i){if(g(e,t))return d("month",t,e,!0,i);var r=0;if(e.getDate()>1){var n=new Date(e.getFullYear(),e.getMonth()+1,1);r=d("month",n,e,!0),e=n}var s=0;g(e,t)||(s=d("month",webix.Date.monthStart(t),e),e=webix.Date.add(e,s,"month",!0));return r+s+d("month",t,e,!0)}(e,i,n):d(t,e,i,r,n)}}function g(t,e){return webix.Date.equal(webix.Date.monthStart(t),webix.Date.monthStart(e))}function v(t){return p[t]}function m(t,e){var i;switch(t){case"year":return new Date(e.getFullYear(),0,1);case"quarter":return new Date(e.getFullYear(),3*Math.floor(e.getMonth()/3),1);case"month":return new Date(e.getFullYear(),e.getMonth(),1);case"week":return(i=new Date(e.getFullYear(),e.getMonth(),e.getDate())).setDate(e.getDate()-c(e)),i;case"day":return(i=new Date(e.getFullYear(),e.getMonth(),e.getDate())).setHours(0,0,0,0),i;case"hour":return(i=new Date(e.getFullYear(),e.getMonth(),e.getDate())).setHours(e.getHours(),0,0,0),i;default:return new Date(e)}}function y(t,e,i,r,n){var s=i.start,a=i.end,o=i.cellWidth,l=i.cellHeight,c=i.diff,u=i.minUnit,h=i.precise,p=t.start_date<s?s:t.start_date,d=t.end_date>a?a:t.end_date,f=m(u,s),g="milestone"==t.type;t.$h=r,t.$x=Math.round(c(p,f,h)*o)-(g?t.$h/2:0),t.$w=g?t.$h:Math.round(c(d,p,h,!0)*o),t.$y=webix.isUndefined(n)?l*e+(l-r)/2:n}function _(t){t.duration=0,t.end_date=t.start_date}function w(t){return t.duration<1?v("hour")(t.start_date,Math.floor(24*t.duration)):v("day")(t.start_date,t.duration)}function b(t,e){if(t.duration<1)return w(t);for(var n=function(t){return i.datePart(t,!0)}(t.start_date),s=0,a=0;s<t.duration;)e.isHoliday(n)?30==++a&&S():(++s,a=0),n=r(n,1);return n}function x(t,e){var i=f("day")(t.end_date,t.start_date,!0);if(i<1)return parseFloat(i.toFixed(2));if(!e)return Math.floor(i);for(var n=t.start_date,s=0;n<t.end_date;)e.isHoliday(n)||++s,n=r(n,1);return s}function k(t,e){for(var i,n=t,s=t,a=0;a<30&&(i=e.isHoliday(s))&&e.isHoliday(n);)n=r(n,-1),s=r(s,1),a++;return 30===a&&S(),i?n:s}function S(){throw alert("No work days found within 30 days, check your isHoliday function!","error"),"Wrong isHoliday function"}function T(t,e,i,n){for(var s=0;s<30&&i.isHoliday($(t,e));)t=r(t,n),s++;return 30===s&&S(),t}function $(t,e){return e&&!function(t){return i.timePart(t)}(t)?r(t,-1):t}e.addUnit=v,e.getDiff=f,e.getUnitStart=m,e.grid=function(t,e,i){var r=document.createElement("canvas");r.setAttribute("width",t),r.setAttribute("height",e);var n=r.getContext("2d");return n.strokeStyle=i,n.moveTo(0,e),n.lineTo(t,e),n.lineTo(t,0),n.stroke(),r.toDataURL()},e.newLink=function(t,e,i){if(e&&i){var r=i.x-e.x,n=i.y-e.y,s=(r>0?e.x:i.x)-t.left,a=(n>0?e.y:i.y)-t.top,o=(r>0?0:-r)+","+(n>0?0:-n)+","+(r>0?r:0)+","+(n>0?n:0);return{width:Math.abs(r),height:Math.abs(n),left:s,top:a,p:o}}return null},e.resetScales=function(t,e,i,r,n,s,a){var u=function(t){var e=new Date;return t.map((function(t){return{item:t,len:v(t.unit)(e,1)}})).sort((function(t,e){return t.len<e.len?-1:1}))[0].item.unit}(s),h=f(u),p=m(u,e);t=m(u,t),e=p<e?v(u)(p,1):p;var d=h(e,t)*r,g=n*s.length;return{rows:s.map((function(i){for(var s=[],a=v(i.unit),p=i.step||1,d="week"===u&&"week"!==i.unit,f=m(i.unit,t);f<e;){var g=a(f,p);f<t&&(f=t),g>e&&(g=e);var y=f,_=g;d&&(c(f)>3&&(y=webix.Date.add(f,1,"week",!0)),c(g)>3&&(_=webix.Date.add(g,1,"week",!0)));var w=(h(_,y)||1)*r,b="function"==typeof i.format?i.format(f,g):o(f,i.format),x="";i.css&&(x+="function"==typeof i.css?i.css(f):i.css),s.push({width:w,value:b,css:x,date:f,format:l(i.format)}),f=g}return{cells:s,add:a,height:n,type:i.unit,step:i.step||1}})),width:d,height:g,cellWidth:r,cellHeight:n,diff:h,start:t,end:e,minUnit:u,precise:i=!!("day"===u?i:0!=i),isHoliday:a}},e.smallerCount=h,e.updateLink=function(t,e,i,r){var n,s,a,o,l=Math.round(r/2);if(!e||!i)return t.$p="",t;var c,u,h=!1,p=!1;switch(t.type){case 0:p=!0;break;case 1:h=!0,p=!0;break;case 3:h=!0}if(n=h?e.$x:e.$x+e.$w,s=e.$y,a=p?i.$x:i.$x+i.$w,o=i.$y,function(t,e,i,r,n){return"milestone"===t.type||"milestone"===e.type?Math.abs(i-r)>n/2:i!==r}(e,i,n,a,r)||s!==o){var d=function(t,e,i,r,n,s,a){var o=t+20*(n?-1:1),l=i+20*(s?-1:1),c=[t,e,o,e,0,0,0,0,l,r,i,r],u=l-o,h=r-e,p=s===n;!p&&(l<=t+20-2&&s||l>t&&!s)&&(h-=a);p&&s&&o>l||p&&!s&&o<l?(c[4]=c[2]+u,c[5]=c[3],c[6]=c[4],c[7]=c[5]+h):(c[4]=c[2],c[5]=c[3]+h,c[6]=c[4]+u,c[7]=c[5]);return c.join(",")}(n,s+l,a,o+l,h,p,19),f=(c=a,u=o+l,p?c-5+","+(u-3)+","+(c-5)+","+(u+3)+","+c+","+u:c+5+","+(u+3)+","+(c+5)+","+(u-3)+","+c+","+u);t.$p=d+","+f}else t.$p="";return t},e.updateTask=function(t,e,i,r,n){return"split"===t.type&&t.$data&&t.$data.length?t.$data.forEach((function(t){return y(t,e,i,r)})):y(t,e,i,r,n),t},e.updateTaskDuration=function(t,e,i,r){t.start_date&&t.end_date&&t.start_date.valueOf()>=t.end_date.valueOf()&&(t.end_date=null,t.duration=1,i&&(i="move")),e?function(t,e,i,r){if("milestone"==t.type)return t.start_date=i?T(t.start_date,!1,e,r):k(t.start_date,e),_(t);i?"start"==i||"move"==i?(t.start_date=T(t.start_date,!1,e,r),t.duration||(t.duration=x(t,e)),t.end_date||(t.end_date=b(t,e))):(t.end_date||(t.end_date=b(t,e)),t.duration||(t.end_date=T(t.end_date,!0,e,r),t.duration=x(t,e))):(t.start_date=k(t.start_date,e),t.end_date=b(t,e),t.duration=x(t,e))}(t,e,i,r):"milestone"==t.type?_(t):(t.duration||(t.duration=x(t)),t.end_date||(t.end_date=w(t)))}}));(W=z)&&W.__esModule&&Object.prototype.hasOwnProperty.call(W,"default")&&W.default;var N=z.addUnit,G=z.getDiff,q=z.getUnitStart,Y=z.grid,X=z.newLink,K=z.resetScales,J=z.smallerCount,Z=z.updateLink,Q=z.updateTask,tt=z.updateTaskDuration;function et(t){var e=webix.copy(nt);e.view=t,e.master=this,e.Local=this.app.getService("local"),webix.DragControl.addDrag(t.$view,e),webix.DragControl.addDrop(t.$view,e,!0)}function it(t,e){var i=t.getBoundingClientRect(),r=(e-i.left)/i.width,n=webix.env.touch?400:200,s=.2/(i.width>n?i.width/n:1);return r<s?"start":r>1-s?"end":"move"}function rt(t){var e=this.Local.getScales();return t.senseX=Math.round(e.cellWidth*(webix.env.touch?1:.5)),t.senseY=Math.round(e.cellHeight*(webix.env.touch?3:1)),t}var nt={$longTouchLimit:!0,$dragCreate:function(t,e){if(this.master.State.readonly)return!1;var i=this.locateEvent(e),r=this.getContext();if(i){var n=this.view.getItem(i);if(n.$group)return!1;var s=e.target;if(s.classList.contains("webix_gantt_link"))return r.mode="links",at[r.mode].$dragCreate.call(this,t,e,i);var a=this.view.getItemNode(i);if(!webix.env.touch&&function(t,e){for(;t!=e;){if(t.classList.contains("webix_gantt_progress_drag"))return!0;t=t.parentNode}return!1}(s,a))return r.mode="progress",at[r.mode].$dragCreate.call(this,t,e,i);var o=this.view.getScrollState(),l=this.getEventContext(e),c=it(a,l.x);"task"==n.type||"start"!=c&&"end"!=c||(c="move");var u=this.Local.getScales(),h=u.cellWidth;if(u.precise){var p=J[u.minUnit][1];h=Math.round(h/("number"==typeof p?p:p()))}if(webix.extend(r,{id:i,mode:c,node:a,step:h,dx:0,from:this.view,snode:t.querySelector(".webix_scroll_cont"),x:l.x,scroll:o,t:parseInt(a.style.top),l:parseInt(a.style.left),w:parseInt(a.style.width)},!0),!this.master.app.callEvent("bars:beforedrag",[n,r]))return!1;at[r.mode].dragScroll&&webix.extend(r,rt.call(this,at[r.mode].dragScroll));var d=a.cloneNode(!0);return d.className+=" webix_drag_zone webix_gantt_mode_"+c,a.style.visibility="hidden",webix.html.addCss(t,"webix_gantt_in_action",!0),t.style.cursor="move"==c?"move":"ew-resize",t.appendChild(d),d}return!(!this.master.app.config.split||"resources"===this.master.State.display||e.target!=t)&&(r.mode="split",at[r.mode].$dragCreate.call(this,t,e))},$dragDestroy:function(t,e){var i=this,r=this.getContext();return at[r.mode].dragScroll&&F.reset(r),r.mode&&at[r.mode].$dragDestroy?at[r.mode].$dragDestroy.call(this,t,e):(r.$waitUpdate?r.$waitUpdate.catch((function(){i.master.Action({action:"update-task-time",id:r.id})})):r.$waitUpdate=this.master.Action({action:"update-task-time",id:r.id}),r.$waitUpdate.finally((function(){r.node.style.visibility="",webix.html.remove(e),i.master.app.config.split&&r.id&&i.master.Action({action:"split-resize",id:r.id})})),t.style.cursor="",webix.html.removeCss(t,"webix_gantt_in_action"),!1)},$dragIn:function(t,e,i){var r=this.getContext();return!!r.mode&&(at[r.mode].dragScroll&&(F.reset(r),F.start(r,i)),!at[r.mode].$dragIn||at[r.mode].$dragIn.call(this,t,e,i))},$dragPos:function(t){var e=this.getContext();return at[e.mode].$dragPos.call(this,t)},$dragOut:function(t,e,i,r){var n=this.getContext();return at[n.mode].$dragOut?at[n.mode].$dragOut.call(this,t,e,i,r):null},$drop:function(t,e,i){var r=this.getContext();if(!r.mode)return!1;if(at[r.mode].$drop)return at[r.mode].$drop.call(this,t,e,i);var n=r.id,s=r.mode,a=r.dx,o=r.step,l=Math.round(a/o);if(r.timeShift=l,!this.master.app.callEvent("bars:beforedrop",[this.view.getItem(r.id),r]))return!1;r.$waitUpdate=this.master.Action({action:"update-task-time",mode:s,time:l,id:n})},locateEvent:function(t,e){return webix.env.touch&&e&&(t=document.elementFromPoint(e.x,e.y)),webix.html.locate(t,"webix_l_id")},getEventContext:function(t){if(webix.env.touch){if(t.changedTouches&&(!t.touches||!t.touches[0])){var e=t.changedTouches[0];return{x:e.pageX,y:e.pageY}}return t.time?t:webix.env.mouse.context(t)}return{x:t.clientX,y:t.clientY}},getContext:function(){return webix.DragControl.getContext()},setDragOffset:function(t,e,i){var r=this.getContext(),n=webix.html.pos(i),s=webix.html.offset(t);r.width=s.width,r.height=s.height,r.x_offset=s.x-n.x,r.y_offset=s.y-n.y}},st={$dragPos:function(t){var e=this.getContext(),i=this.view.getScrollState(),r=webix.DragControl.getNode(),n=e.mode,s=e.l,a=e.t,o=e.w,l=e.x,c=e.id,u=e.scroll,h=e.step,p=e.dx=t.x-l-u.x+i.x;"start"===n?(t.x=Math.min(s+p,s+o-h),r.style.width=Math.max(o-p,h)+"px"):"end"===n&&(t.x=s,r.style.width=Math.max(o+p,h)+"px"),t.y=a,this.master.Action({action:"drag-task",id:c,left:t.x,width:parseInt(r.style.width)}),this.master.app.config.split&&this.master.Action({action:"split-resize",id:c})}},at={links:{dragScroll:{direction:"xy"},$dragCreate:function(t,e,i){var r=this.getContext(),n=e.target,s=this.view.getItemNode(i),a=this.view.getScrollState(),o=webix.html.offset(n),l=n.classList;if(webix.extend(r,{id:i,from:this.view,node:s,link:n,fromStart:l.contains("webix_gantt_link_left"),start:{x:o.x+o.width/2+a.x,y:o.y+o.height/2+a.y}},!0),!this.master.app.callEvent("bars:beforedrag",[this.view.getItem(i),r]))return!1;at[r.mode].dragScroll&&webix.extend(r,rt.call(this,at[r.mode].dragScroll)),n.style.opacity=1,webix.html.addCss(s,"webix_gantt_task_in_action",!0);var c=webix.html.create("div",{visibility:"hidden"});return document.body.appendChild(c),c},$dragDestroy:function(t,e){var i=this.getContext();if(this.master.Action({action:"temp-link"}),i.target){var r=this.view.getItemNode(i.target);webix.html.removeCss(r,"webix_gantt_link_visible")}return i.link.style.opacity="",webix.html.removeCss(i.node,"webix_gantt_task_in_action"),webix.html.remove(e),!1},$dragIn:function(t,e,i){var r=this.getContext(),n=this.getEventContext(i),s=this.locateEvent(i,n);if(!s)return!1;var a=this.view.getItemNode(s);return s!=r.target&&(webix.html.addCss(a,"webix_gantt_link_visible",!0),r.target=s),a},$dragPos:function(t){var e=this.getContext(),i=this.view.getScrollState();e.end={x:t.x+i.x,y:t.y+i.y},this.master.Action({action:"temp-link",start:e.start,end:e.end})},$dragOut:function(t,e,i,r){var n=this.getContext(),s=this.getEventContext(r),a=this.locateEvent(r,s);if(n.target&&a!=n.target){var o=this.view.getItemNode(n.target);webix.html.removeCss(o,"webix_gantt_link_visible"),n.target=null}return null},$drop:function(t,e,i){var r=this.getContext(),n=r.id,s=this.getEventContext(i),a=this.locateEvent(i,s);if(!a||n==a)return!1;var o=this.view.getItemNode(a).getBoundingClientRect(),l=s.x-o.left<o.width/2,c=r.linkType=(r.fromStart?1:0)+(l?0:2);r.targetId=a,this.master.app.callEvent("bars:beforedrop",[this.view.getItem(n),r])&&this.master.Action({action:"add-link",source:n,target:a,type:c})}},move:{dragScroll:{direction:"x"},$dragPos:function(t){var e=this.getContext(),i=e.node,r=e.l,n=e.t,s=e.x,a=e.id,o=e.scroll,l=this.view.getScrollState(),c=e.dx=t.x-s-o.x+l.x;t.x=r+c,t.y=n,this.master.Action({action:"drag-task",id:a,left:t.x,width:parseInt(i.style.width)}),this.master.app.config.split&&this.master.Action({action:"split-resize",id:a})}},progress:{$dragCreate:function(t,e,i){var r=this.getContext(),n=this.view.getItemNode(i),s=this.view.getItem(i).progress,a=n.querySelector(".webix_gantt_progress"),o=this.getEventContext(e),l=this.view.getScrollState();if(webix.extend(r,{id:i,node:n,prevProgress:s,progressNode:a,from:this.view,x:o.x,w:parseInt(n.style.width),scroll:l},!0),!this.master.app.callEvent("bars:beforedrag",[this.view.getItem(i),r]))return!1;t.style.cursor="ew-resize",webix.html.addCss(t,"webix_gantt_in_action",!0),webix.html.addCss(n,"webix_gantt_mode_progress",!0);var c=webix.html.create("div",{visibility:"hidden"});return document.body.appendChild(c),c},$dragPos:function(t){var e=this.getContext(),i=e.x,r=e.scroll,n=e.w,s=e.node,a=this.view.getScrollState(),o=t.x-i-r.x+a.x,l=Math.min(Math.max(e.prevProgress+Math.round(100*o/n),0),100);e.progress!=l&&(e.progress=l,at[e.mode].updateTaskTemplate.call(this,e,l)),s.style.zIndex="3",s.style.boxShadow=("contast"===webix.skin.$name?"#393939":"#ffffff")+" -1px 0px 0px"},$drop:function(){var t=this.getContext(),e=t.id,i=t.progress,r=t.prevProgress;!webix.isUndefined(i)&&i!=r&&this.master.app.callEvent("bars:beforedrop",[this.view.getItem(e),t])&&(t.$waitUpdate=this.master.Action({action:"update-task-progress",progress:i,id:e}))},$dragDestroy:function(t,e){var i=this,r=this.getContext();return r.$waitUpdate?r.$waitUpdate.catch((function(){i.master.Action({action:"update-task-progress",id:r.id})})):r.$waitUpdate=this.master.Action({action:"update-task-progress",id:r.id}),t.style.cursor="",webix.html.removeCss(t,"webix_gantt_in_action"),webix.html.removeCss(r.node,"webix_gantt_mode_progress"),webix.html.remove(e),!1},updateTaskTemplate:function(t,e){var i=t.progressNode;i.style.width=e+"%",i.innerHTML=this.master.DragProgressTemplate(e)}},start:st,end:st,split:{$dragCreate:function(t,e){var i=webix.html.create("DIV",{class:"webix_gantt_split_selection"}),r=this.Local.getScales(),n=this.view.getScrollState(),s=e.target.getBoundingClientRect(),a=Math.floor((e.y-s.y+n.y)/r.cellHeight),o=e.x-s.x;i.style.top=a*r.cellHeight+6+"px",i.style.left=o+n.x+"px",i.style.height=r.cellHeight-14+"px",i.style.width="0px";var l=r.cellWidth;if(r.precise){var c=J[r.minUnit][1];l=Math.round(l/("number"==typeof c?c:c()))}var u=this.getContext();webix.extend(u,{from:this.view,node:i,start:{offsetX:o,clientX:e.clientX},index:a,step:l,scroll:n},!0),t.appendChild(i);var h=webix.html.create("div",{visibility:"hidden"});return document.body.appendChild(h),h},$dragPos:function(t){var e=this.getContext(),i=e.dx=t.x-e.start.clientX;t.x<e.start.clientX?(e.node.style.left=e.start.offsetX+e.scroll.x+i+"px",e.node.style.width=-i+"px"):(e.node.style.left=e.start.offsetX+e.scroll.x+"px",e.node.style.width=t.x-e.start.clientX+"px")},$drop:function(){var t=this.getContext(),e=this.view.getIdByIndex(t.index),i=Math.round((t.start.offsetX+t.scroll.x)/t.step),r=Math.round(t.dx/t.step);r<0&&(i+=r,r*=-1),this.master.Action({action:"add-task",id:e,dates:{start:i,end:r}})},$dragDestroy:function(t,e){var i=this.getContext();return webix.html.remove(e),webix.html.remove(i.node),!1}}},ot=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this;this.State=this.getParam("state",!0);var e=this.app.getService("locale")._;return{view:"abslayout",css:this.State.readonly||!this.app.config.links?"webix_gantt_readonly":"",borderless:!0,cells:[{view:"template",css:"webix_gantt_holidays",borderless:!0,relative:!0},{view:"template",css:"webix_gantt_links",borderless:!0,relative:!0},{view:"list",borderless:!0,type:this.BarsType(e),css:"webix_gantt"+(webix.env.touch?"_touch":"")+"_bars",on:{onItemClick:function(e){return t.ItemClickHandler(e)}},tooltip:function(i){return t.GetTooltip(i,e)},scroll:"xy",relative:!0}]}},e.prototype.init=function(t){var e=this,i=t.getChildViews(),r=i[0],n=i[1],s=i[2];this.Holidays=r,this.Links=n,this.Bars=s,this.Ops=this.app.getService("operations"),this.Helpers=this.app.getService("helpers");var a=this.Local=this.app.getService("local"),o=a.getScales(),l=a.links(),c=this.LinksData=l.data;this.Calendars=this.app.config.resourceCalendars,this.HandleScroll(),this.HandleDrag(o),this.HandleSelection(o),this.InitMarkers(),this.HandleHolidays(o),this.on(this.State.$changes,"display",(function(t,i){e.SyncData(!0),i&&(e.Local.refreshLinks(),e.RefreshLinks(),e.Calendars&&e.RenderResourceHolidays())})),this.DrawGrid(t,o),this.on(this.app,"onScalesUpdate",(function(i){e.DrawGrid(t,i),e.Bars.refresh(),e.RefreshLinks()})),this.on(this.VisibleTasks.data,"onStoreUpdated",(function(t,i,r){e.RefreshLinks(),"update"!==r&&e.ApplySelection(),!r&&e.Calendars&&e.RenderResourceHolidays()})),this.on(c,"onStoreUpdated",(function(){e.RefreshLinks()})),this.on(this.State.$changes,"criticalPath",(function(t,i){webix.isUndefined(i)||(e.Local.showCriticalPath(!t),e.RefreshLinks())})),this.on(this.State.$changes,"compact",(function(){e.RefreshLinks()})),this.Calendars&&this.on(this.Local.assignments().data,"onStoreUpdated",(function(t,i,r){if(e.RenderResourceHolidays(),e.app.config.excludeHolidays&&r){var n=e.Local.tasks().getItem(i.task);n&&e.Ops.updateAssignedTaskDates(n)}}))},e.prototype.ItemClickHandler=function(t){this.Bars.getItem(t).$group||this.State.$batch({parent:null,selected:t})},e.prototype.DrawGrid=function(t,e){t.$view.style.backgroundImage="url("+Y(e.cellWidth,e.cellHeight,"contrast"==webix.skin.$name?"#808080":"#ccc")+")",t.$view.style.marginTop="0px";var i=this.app.getState();t.$view.style.backgroundPosition="-"+i.left+"px -"+i.top+"px",this.Resize(e.width)},e.prototype.SyncData=function(t){var e=this;this.Bars.clearAll(),this.VisibleTasks=this.Local.getVisibleTasksCollection(),this.Calendars?this.Local.taskCalendarMap().then((function(){e.Bars.sync(e.VisibleTasks)})):this.Bars.sync(this.VisibleTasks),this.ApplySelection(t)},e.prototype.BarsTemplate=function(t,e){var i=t.text||(t.$group?e("Unassigned"):e("(no title)"));return"milestone"==t.type?"<span>"+i+"</span>":i},e.prototype.BarsType=function(t){var e=this;return{template:function(i){if("tasks"===e.State.display&&"split"===i.type&&i.$data&&i.$data.length){var r=e.GetSplitBox(i),n=r.height,s=r.width,a=r.left,o=r.top,l='<div class="webix_gantt_split_container" webix_s_id="'+i.id+'" style="top:'+o+"px;left:"+a+"px;height:"+n+"px;width:"+s+'px;"></div>',c=e.VisibleTasks.data.order,u=c.length>1&&i.id==c[c.length-1];return i.$data.forEach((function(i){l+=e.TemplateStart(i,u)+e.BarsTemplate(i,t)+e.TemplateEnd(i)})),l}return e.BarsTemplate(i,t)},templateStart:function(t){if("tasks"===e.State.display&&"split"===t.type&&t.$data&&t.$data.length)return"";var i=e.VisibleTasks.data.order,r=i.length>1&&t.id==i[i.length-1];return e.TemplateStart(t,r)},templateEnd:function(t){return"tasks"===e.State.display&&"split"===t.type&&t.$data&&t.$data.length?"":e.TemplateEnd()}}},e.prototype.GetSplitBox=function(t){var e=t.$data[0],i=t.$data[t.$data.length-1],r=i.$x+("milestone"==i.type?Math.floor(i.$w/2):0),n="milestone"==e.type?Math.floor(e.$w/2):e.$w;return{top:e.$y,left:r,height:e.$h,width:e.$x-r+n}},e.prototype.TemplateStart=function(t,e){var i="milestone"==t.type,r=t.$w,n=t.$h,s=0,a="";if(i)r=n=Math.ceil(Math.sqrt(Math.pow(t.$w,2)/2)),s=Math.ceil((t.$w-r)/2);else{var o="task"==t.type?this.DragProgressTemplate(t.progress):"";a='<div class="webix_gantt_progress" style="width:'+t.progress+'%;">'+o+"</div>"}var l="webix_gantt_task_base webix_gantt_"+("split"===t.type?"task":t.type);return t.$critical&&(l+=" webix_gantt_critical"),t.$group&&(l+=" webix_gantt_group"),e&&(l+=" webix_gantt_last"),'<div webix_l_id="'+t.id+'" \n\t\t\tclass="'+l+'" \n\t\t\tstyle="left:'+(t.$x+s)+"px;top:"+(t.$y+s)+"px;width:"+r+"px;height:"+n+'px;" \n\t\t\tdata-id="'+t.id+'">\n\t\t\t\t<div class="webix_gantt_link webix_gantt_link_left"></div>\n\t\t\t\t'+a+'\n\t\t\t\t<div class="webix_gantt_content">'},e.prototype.TemplateEnd=function(){return'</div><div class="webix_gantt_link webix_gantt_link_right"></div></div>'},e.prototype.DragProgressTemplate=function(t){return'<div class="webix_gantt_progress_drag" style="left:'+t+'%">\n\t\t\t<span class="webix_gantt_progress_percent">'+t+"</span>\n\t\t</div>"},e.prototype.HandleDrag=function(){var t=this;et.call(this,this.Bars),webix.env.touch||(this._mousemove_handler=webix.event(this.Bars.$view,"mousemove",(function(e){return function(t,e){if(!webix.DragControl.active){var i=webix.html.locate(t,"webix_l_id");if(i&&"task"==e.getItem(i).type){var r=e.getItemNode(i),n=it(r,t.clientX);r.style.cursor="move"==n?"pointer":"ew-resize"}}}(e,t.Bars)})))},e.prototype.destroy=function(){this._mousemove_handler=webix.eventRemove(this._mousemove_handler),this._scroll_handler=webix.eventRemove(this._scroll_handler);var t=this.app.config.markers;if(t)for(var e=0;e<t.length;e++){var i=t[e];i.$interval&&(i.$interval=clearInterval(i.$interval))}},e.prototype.GetLinks=function(t){return this.Links.$view.querySelector(".webix_gantt_"+(t?"temp_line":"lines"))},e.prototype.HandleScroll=function(){var t=this;this._scroll_handler=webix.event(this.Bars.$view,"scroll",(function(e){var i=e.target,r=Math.round(i.scrollTop),n=Math.round(i.scrollLeft);if(t.holidaysContainer.style.height="0px",t.containerForMarkers.style.height="0px",t.app.config.links){var s=t.GetLinks(),a=t.GetLinks(!0),o={viewBox:n+" "+r+" "+i.scrollWidth+" "+i.scrollHeight,width:i.scrollWidth,height:i.scrollHeight};for(var l in o)s.setAttribute(l,o[l]),a.setAttribute(l,o[l])}t.SetHolidaysScroll(i.scrollHeight,n,r),t.containerForMarkers.style.height=i.scrollHeight+"px",t.getRoot().$view.style.backgroundPosition="-"+n+"px -"+r+"px",t.State.$batch({top:r,left:n})})),this.on(this.State.$changes,"top",(function(e){t.Bars.scrollTo(t.State.left,e)})),this.app.config.resources&&(this.on(this.State.$changes,"left",(function(e){t.State.resourcesDiagram&&t.Bars.scrollTo(e,t.State.top)})),this.on(this.app,"rdiagram:resize",(function(){t.holidaysContainer.style.height=t.Bars.$view.scrollHeight+"px",t.containerForMarkers.style.height=t.Bars.$view.scrollHeight+"px"})))},e.prototype.SetHolidaysScroll=function(t,e,i){this.holidaysContainer.style.height=t+"px",this.holidaysContainer.style.left=-e+"px",this.holidaysContainer.style.top=-i+"px",this.Calendars&&(this.resHolidaysContainer.style.height=t+"px",this.resHolidaysContainer.style.left=-e+"px",this.resHolidaysContainer.style.top=-i+"px")},e.prototype.HandleSelection=function(t){var e=this;this.selLine=webix.html.create("DIV",{class:"webix_gantt_bar_selection",style:"height:"+t.cellHeight+"px;width:"+t.width+"px"}),this.Bars.$view.insertBefore(this.selLine,this.Bars.$view.firstChild),this.on(this.State.$changes,"selected",(function(){return e.ApplySelection()}))},e.prototype.ApplySelection=function(t){var e=this.State.selected,i=-100;if(e&&this.Bars.data.order.length){var r=i=this.Bars.getIndexById(e),n=this.Bars.getItem(e);r<0&&("tasks"==this.State.display&&n&&0!=n.parent&&"split"===this.Bars.getItem(n.parent).type?r=this.Bars.getIndexById(n.parent):t&&!this.Bars.exists(e)&&(this.State.selected=null)),i=r*this.Local.getScales().cellHeight,this.ScrollToTask(n)}this.selLine.style.top=i+"px"},e.prototype.ScrollToTask=function(t){if(t){var e=this.Bars;(t.$x>e.$width-this.Local.getScales().cellWidth||t.$x<e.$view.scrollLeft)&&(this.State.left=t.$x-30)}this.Bars.scrollTo(this.State.left,this.State.top)},e.prototype.InitMarkers=function(){var t=this;this.containerForMarkers=webix.html.create("DIV",{class:"webix_gantt_markers",style:"height:"+this.Bars.$view.scrollHeight+"px"}),this.Bars.$view.insertBefore(this.containerForMarkers,this.Bars.$view.firstChild),this.RenderMarkers(this.app.config.markers),this.on(this.app,"onScalesUpdate",(function(){return t.RenderMarkers(t.app.config.markers)}))},e.prototype.RenderMarkers=function(t){var e=this;if(t){for(var i=[],r=0;r<t.length;r++){var n=t[r];n.now&&(n.start_date=new Date,n.$interval||(n.$interval=setInterval((function(t){e.containerForMarkers.querySelector('[gantt_now="'+t.$interval+'"]').style.left=e.GetMarkerPosition(new Date)+"px"}),3e5,n))),i.push(this.MarkerTemplate(t[r]))}this.containerForMarkers.innerHTML=i.join("")}},e.prototype.MarkerTemplate=function(t){var e=t.text?'<span class="webix_gantt_marker_text">'+t.text+"</span>":"";return'<div\n\t\t\tgantt_now="'+t.$interval+'"\n\t\t\tclass="webix_gantt_marker '+(t.css||"")+'"\n\t\t\tstyle="left:'+this.GetMarkerPosition(t.start_date)+'px">'+e+"</div>"},e.prototype.GetMarkerPosition=function(t){var e=this.Local.getScales(),i=e.start,r=e.end,n=e.cellWidth,s=e.diff,a=e.minUnit,o=q(a,i);return t<i||t>r?-100:Math.round(s(t,o,!0)*n)},e.prototype.LinksTemplate=function(t,e){var i=this.Bars.$view;return'<svg\n\t\t\tclass="'+e+'"\n\t\t\tviewBox="'+this.State.left+" "+this.State.top+" "+i.scrollWidth+" "+i.scrollHeight+'"\n\t\t\twidth="'+i.scrollWidth+'"\n\t\t\theight="'+i.scrollHeight+'"\n\t\t>'+t+"</svg>"},e.prototype.RefreshLinks=function(){var t=this,e=[];if(this.LinksData.count()&&this.VisibleTasks.count()){var i=this.LinksData;i.order.each((function(r){var n=i.getItem(r);if(n.$p){var s=t.State.criticalPath&&t.Local.isLinkCritical(n);e.push('<polyline data-id="'+r+'" '+(s?"class='webix_gantt_line_critical'":"")+' points="'+n.$p+'" />')}}))}var r=this.LinksTemplate(e.join(""),"webix_gantt_lines")+this.LinksTemplate('<polyline points="" />',"webix_gantt_temp_line");this.Links.setHTML(r)},e.prototype.RefreshTaskLinks=function(t){var e=this;this.LinksData.find((function(e){return e.source==t||e.target==t})).forEach((function(t){var i=e.Links.$view.querySelector('[data-id="'+t.id+'"]');if(i){var r=e.VisibleTasks.getItem(t.source),n=e.VisibleTasks.getItem(t.target);Z(t,r,n,e.Local.getTaskHeight()),i.setAttribute("points",t.$p)}}))},e.prototype.Resize=function(t){var e=this.Bars.$view.querySelector(".webix_scroll_cont");e.style.width=t+"px",e.style.minHeight="1px",this.selLine&&(this.selLine.style.width=t+"px")},e.prototype.Action=function(t){var e=this.app.getService("operations"),i=null;if("update-task-time"===t.action)t.time?i=e.updateTaskTime(t.id,t.mode,t.time):(this.Local.refreshTasks(t.id),"resources"===this.State.display&&this.VisibleTasks.refresh(t.id),this.RefreshTaskLinks(t.id));else if("update-task-progress"===t.action)if(webix.isUndefined(t.progress)){var r=this.VisibleTasks.getItem(t.id);this.Bars.render(t.id,r,"paint")}else i=e.updateTask(t.id,{progress:t.progress});else if("drag-task"===t.action){(r=this.VisibleTasks.getItem(t.id)).$x=parseInt(t.left),r.$w=parseInt(t.width),this.RefreshTaskLinks(t.id)}else if("add-link"===t.action){var n=t.source,s=t.target,a=t.type;i=e.addLink({source:n,target:s,type:a})}else if("temp-link"===t.action){var o=t.start,l=t.end,c=this.GetLinks(!0).firstChild;if(o){var u=X(this.Links.$view.getBoundingClientRect(),o,l),h=u.left,p=u.top,d=u.p,f=[h,p],g=d.split(",").map((function(t,e){return 1*t+f[e%2]})).join(",");c.setAttribute("points",g)}else c.setAttribute("points","")}else if("add-task"===t.action){var v=this.Local.getScales(),m=v.precise?J[v.minUnit][0]:v.minUnit;o=N(m)(v.start,t.dates.start),l=N(m)(o,t.dates.end);this.app.callEvent("task:add",[t.id,{start:o,end:l}])}else if("split-resize"===t.action&&"resources"!==this.State.display){if(0!=(r=this.VisibleTasks.getItem(t.id)).parent){var y=this.VisibleTasks.getItem(r.parent);if("split"===y.type){var _=this.Bars.$view.querySelector('[webix_s_id="'+r.parent+'"]');y.$data.sort((function(t,e){return e.$x-t.$x}));var w=this.GetSplitBox(y),b=w.width;h=w.left;_.style.width=b+"px",_.style.left=h+"px"}}}return i||webix.promise.resolve()},e.prototype.HandleHolidays=function(t){var e=this,i="<div class='webix_gantt_bar_holidays' style='height:"+this.Bars.$view.scrollHeight+"px'></div>";this.Calendars&&(i+="<div class='webix_gantt_bar_resource_holidays' style='height:"+this.Bars.$view.scrollHeight+"px'></div>"),this.Holidays.setHTML(i),this.holidaysContainer=this.Holidays.$view.querySelector(".webix_gantt_bar_holidays"),this.resHolidaysContainer=this.Holidays.$view.querySelector(".webix_gantt_bar_resource_holidays"),this.RenderHolidays(t),this.on(this.app,"onScalesUpdate",(function(t){return e.RenderHolidays(t)})),this.on(this.app.getRoot(),"onViewShow",(function(){e.refresh()}))},e.prototype.EachScaleDate=function(t,e){if("day"===t.minUnit||"hour"===t.minUnit){var i=webix.Date.copy(t.start),r=webix.Date.dayStart(t.end);t.end-r||(r=webix.Date.add(r,-1,"day",!0));for(var n=t.start.getHours();i<=r;)e.call(this,i,n),i=webix.Date.add(webix.Date.dayStart(i),1,"day",!0),n=webix.Date.equal(i,r)?24-Math.ceil(webix.Date.timePart(t.end)/60/60):0}},e.prototype.RenderHolidays=function(t){var e=this;if(this.holidaysContainer){var i="";this.EachScaleDate(t,(function(r,n){t.isHoliday(r)&&(i+=e.HolidayTemplate(t,r,n))})),this.holidaysContainer.innerHTML=i,this.Calendars&&this.RenderResourceHolidays(t)}},e.prototype.MarkResourceHolidays=function(t,e,i){var r=this,n=this.Bars.getIndexById(e);if(n<0)return"";var s="",a=0,o=null;return this.EachScaleDate(t,(function(e,l){var c=t.isHoliday(e);r.Helpers.isResourceHoliday(e,i)?c?a&&(s+=r.ResourceHolidayTemplate(t,o,l,n,a),a=0):(a||(o=e),a++):c&&(a&&(s+=r.ResourceHolidayTemplate(t,o,l,n,a),a=0),s+=r.ResourceWorkDayTemplate(t,e,l,n))})),s},e.prototype.RenderResourceHolidays=function(t){var e=this;this.resHolidaysContainer&&(t=t||this.Local.getScales(),this.Local.taskCalendarMap().then((function(i){var r="";if(i)for(var n in i)r+=e.MarkResourceHolidays(t,n,i[n]);e.resHolidaysContainer.innerHTML=r})))},e.prototype.GetDateBox=function(t,e,i,r){var n=q(t.minUnit,t.start),s={x:Math.round(t.diff(e,n)*t.cellWidth),w:("hour"===t.minUnit?24-i:1)*t.cellWidth};return(r||0===r)&&(s.y=t.cellHeight*r,s.h=t.cellHeight),s},e.prototype.HolidayTemplate=function(t,e,i){var r=this.GetDateBox(t,e,i);return"<div class='webix_gantt_holiday' style='"+("left:"+r.x+"px;width:"+r.w+"px;")+"'></div>"},e.prototype.ResourceHolidayTemplate=function(t,e,i,r,n){var s=this.GetDateBox(t,e,i,r),a=s.x,o=s.y;return"<div class='webix_gantt_holiday' style='"+("left:"+a+"px;width:"+s.w*n+"px;top:"+o+"px;height:"+s.h+"px;")+"'></div>"},e.prototype.ResourceWorkDayTemplate=function(t,e,i,r){var n=this.GetDateBox(t,e,i,r),s=n.x,a=n.y;return"<div class='webix_gantt_work_day' style='"+("left:"+(s+.2)+"px;width:"+(n.w-1.2)+"px;top:"+a+"px;height:"+(n.h-1)+"px;")+"'></div>"},e.prototype.GetTooltip=function(t,e){var i=webix.i18n.longDateFormatStr,r=(t.text||e("(no title)"))+"<br>\n\t\t\t<br>"+e("Start date")+": "+i(t.start_date);return"milestone"!=t.type&&(r+="<br>"+e("End date")+": "+i(t.end_date)+"\n\t\t\t<br>"+e("Lasts")+" "+t.duration+" "+(t.duration>1?e("days"):e("day"))),r},e}(u),lt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){return{view:"template",height:20,css:"webix_gantt_scale"}},e.prototype.init=function(){var t=this;this.State=this.getParam("state",!0),this.Local=this.app.getService("local");var e=this.Local.getScales();this.RenderScales(e),this.on(this.app,"onScalesUpdate",(function(e){return t.RenderScales(e)}))},e.prototype.ready=function(){var t=this.getRoot();this.on(this.State.$changes,"left",(function(e){return t.scrollTo(e,null)}))},e.prototype.RenderScales=function(t){var e=this,i=this.getRoot(),r=t.rows.map((function(i){var r=("hour"===i.type||"day"===i.type)&&1===i.step;return'<div class="webix_gantt_scale_row" style=\'height:'+i.height+"px;width:"+t.width+"px'>"+i.cells.map((function(t){return e.CellTemplate(t,r)})).join("")+"</div>"})).join("");i.config.height=t.height,i.setHTML(r),i.resize()},e.prototype.CellTemplate=function(t,e){return'<div class="webix_gantt_scale_cell '+t.css+(e&&this.app.config.isHoliday(t.date)?"webix_gantt_holiday_scale":"")+'" style="width:'+t.width+'px;">'+t.format(t.date)+"</div>"},e}(u),ct=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){return{rows:[lt,ot]}},e.prototype.init=function(){var t=this;this.on(this.app,"bars:toggle",(function(e){e?t.getRoot().show():t.getRoot().hide()}))},e}(u),ut=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){return this.State=this.getParam("state",!0),{view:"abslayout",css:" webix_gantt_readonly",cells:[{view:"template",css:"webix_gantt_holidays",borderless:!0,relative:!0},{view:"tree",borderless:!0,type:this.WorkloadMarkersType(),css:"webix_gantt"+(webix.env.touch?"_touch":"")+"_bars webix_gantt_resdiagram_chart",scroll:"xy",relative:!0,filterMode:{showSubItems:!1,level:0}}]}},e.prototype.init=function(t){var e=this,i=t.getChildViews(),r=i[0],n=i[1];this.Holidays=r,this.Bars=n,this.LocalState=this.getParam("localState"),this._unit="hours";var s=this.Local=this.app.getService("local"),a=this.Scales=s.getScales();this.RDCollection=this.app.getService("grouping").getRDCollection(),this.Helpers=this.app.getService("helpers"),this.on(this.Bars.data,"onSyncApply",(function(){e.Scales=e.Local.getScales(),e.RestoreTreeState(),e.Calendars&&e.RenderResourceHolidays()})),this.Bars.sync(this.RDCollection,(function(){this.filter((function(t){return t.$group}))})),this.Calendars=this.app.config.resourceCalendars,this.DrawGrid(t,a),this.HandleScroll(),this.HandleHolidays(a),this.on(this.app,"onScalesUpdate",(function(i){e.DrawGrid(t,i)})),this.on(this.app,"rdiagram:branch:toggle",(function(t,i){e.ToggleBranch(t,i)})),this.on(this.app,"rdiagram:resize",(function(){e.holidaysContainer.style.height=e.Bars.$view.scrollHeight+"px"})),this.on(this.app,"rdiagram:sort",(function(t,i,r){t?e.Bars.sort(t,i,r):e.Bars.sort(r,i)})),this.Calendars&&this.on(this.Local.assignments().data,"onStoreUpdated",(function(){e.RenderResourceHolidays()}))},e.prototype.ToggleBranch=function(t,e){var i=this;e?this.Bars.open(t):this.Bars.close(t);var r=this.Bars.data.getBranch("0"),n=this.Bars.getState().open.filter((function(t){return r.find((function(e){return e.id==t}))}));this._treeOpened=n.map((function(t){return i.Bars.getIndexById(t)})),this.holidaysContainer.style.height=this.Bars.$view.clientHeight+"px",this.Calendars&&(this.resHolidaysContainer.style.height=this.Bars.$view.clientHeight+"px",this.RenderResourceHolidays())},e.prototype.RestoreTreeState=function(){var t=this;if(this._treeOpened&&this._treeOpened.length){var e=this._treeOpened,i=this.Bars.data.getBranch("0");i.forEach((function(r){var n=i.indexOf(r);r.open=!e.indexOf(n),t.Bars.data.callEvent("onStoreUpdated",[r.id,0,"branch"])}))}else this.Bars.openAll()},e.prototype.HandleScroll=function(){var t=this;this._scroll_handler=webix.event(this.Bars.$view,"scroll",(function(e){var i=e.target,r=Math.round(i.scrollTop),n=Math.round(i.scrollLeft);t.getRoot().$view.style.backgroundPosition="-"+n+"px -"+r+"px",t.State.left=n,t.LocalState.top=r,t.SetHolidaysScroll(i.scrollHeight,n,r)})),this.on(this.LocalState.$changes,"top",(function(e){t.Bars.scrollTo(t.State.left,e)})),this.on(this.State.$changes,"left",(function(e){t.Bars.scrollTo(e,t.LocalState.top)})),this.on(this.app,"rdiagram:unit:change",(function(e){t._unit=e,t.Bars.render()}))},e.prototype.WorkloadMarkersType=function(){var t=this;return{template:function(e){return t.MarkerTemplate(e)},templateStart:function(e,i){return t.MarkerStartTemplate(e,i)},templateEnd:function(){return"</div>"}}},e.prototype.MarkerStartTemplate=function(t,e){return'<div webix_tm_id="'+t.id+'" style="height:'+(this.Scales.cellHeight-8)+'px; padding: 4px;" class="'+e.classname(t,e)+' webix_gantt_diagram_line" '+e.aria(t)+">"},e.prototype.MarkerTemplate=function(t){if(2===t.$level){var e=this.GetMarkerData(t),i=[];for(var r in e)i.push(this.MarkerToHTML(e[r]));return i.join("")}return""},e.prototype.CheckResourceHoliday=function(t,e){if(this.Calendars){var i=this.Bars.getItem(e).resource_id;if(i){var r=this.Local.resources().getItem(i).calendar_id;if(r){var n=this.Local.calendars().getItem(r);return this.Helpers.isResourceHoliday(t,n)}}}return this.app.config.isHoliday(t)},e.prototype.GetMarkerData=function(t){for(var e={},i=0;i<t.duration.length;++i)for(var r=t.duration[i],n=t.units[i],s=t.$x[i]-Math.min.apply(Math,t.$x),a=this.Scales.cellHeight>40?28:20,o=this.Scales.cellWidth-a,l=Math.round(o/2),c=s?-2:l,u=webix.Date.copy(t.start_date[i]),h=0;h<r;++h,c+=o){if(this.app.config.excludeHolidays&&this.CheckResourceHoliday(u,t.id))++r;else{var p=t.$x[i]+h*this.Scales.cellWidth-2,d=0;"hour"!==this.Scales.minUnit&&(d=(h===r-1?n[1]:h?n[2]:n[0])||n[2]),e[p]?(e[p].hours+=d,e[p].count+=1):e[p]={hours:d,x:p+l,count:1}}webix.Date.add(u,1,this.Scales.minUnit)}return e},e.prototype.MarkerToHTML=function(t){var e=t.hours>this.Helpers.unitLoadNorm[this.Scales.minUnit]?"webix_gantt_overload":"",i="hours"===this._unit?t.hours||" ":t.count;return'<div class="webix_gantt_diagram_marker '+e+'" style="left:'+t.x+'px;">'+i+"</div>"},e.prototype.RenderResourceHolidays=function(t){var e=this;t=t||this.Local.getScales();var i="";this.Bars.data.each((function(r){if(r.resource_id){var n=e.Local.resources().getItem(r.resource_id).calendar_id;n&&(i+=e.MarkResourceHolidays(t,r.id,e.Local.calendars().getItem(n)))}})),this.resHolidaysContainer.innerHTML=i},e}(ot);function ht(t){return function(e,i){return e[t].localeCompare(i[t],void 0,{ignorePunctuation:!0,numeric:!0})}}function pt(t,e){return t&&t.length==e.length&&t.every((function(t){return e.includes(t)}))}var dt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this;this.State=this.getParam("state",!0);var e=this.app.getService("local").getScales(),i=this._=this.app.getService("locale")._,r=this.Compact=this.getParam("compact",!0),n=[{id:"name",css:"webix_gantt_title",header:r?"<span class='webix_icon gti-menu'>":i("Name"),template:function(e,i){return t.TreeTemplate(e,i)},fillspace:!0,sort:r?"":ht("name"),minWidth:r?44:150},{id:"load",header:i("Hours"),hidden:r,batch:"hours",sort:"int",minWidth:50,resize:!1},{id:"count",header:i("Tasks"),batch:"tasks",sort:"int",minWidth:50,hidden:!0,resize:!1}],s={view:"treetable",css:"webix_gantt_resdiagram_tree webix_header_border",prerender:!0,borderless:"contrast"===webix.skin.$name,width:r?44:this.State.treeWidth,rowHeight:e.cellHeight,headerRowHeight:e.height,scroll:"xy",scrollAlignY:!1,sort:!0,resizeColumn:{headerOnly:!0,size:10},columns:n,tooltip:function(){return""},on:{onViewResize:function(){t.State.treeWidth=t.Tree.$width},onAfterOpen:function(e){return t.ToggleBranch(e,1)},onAfterClose:function(e){return t.ToggleBranch(e,0)},onAfterSort:function(e,i,r){return t.SortTasks(e,i,r)},onColumnResize:function(e,i,r,n){return t.NormalizeColumns(e,n)}},onClick:{"gti-menu":function(){return t.ToggleColumns()}},filterMode:{showSubItems:!1,level:0}},a=this.LocalState=this.getParam("localState"),o=function(){a.top=this.getScrollState().y};return webix.env.touch?s.on.onSyncScroll=s.on.onAfterScroll=o:s.on.onScrollY=o,s},e.prototype.init=function(t){var e=this;this.Tree=t,this.Helpers=this.app.getService("helpers"),this.Local=this.app.getService("local"),this.RDCollection=this.app.getService("grouping").getRDCollection(),this._unit="hours",this._collapsed=!0,this.on(this.LocalState.$changes,"top",(function(t){e.Tree.scrollTo(null,t)})),this.on(this.Tree.data,"onSyncApply",(function(){return e.RestoreTreeState()})),t.sync(this.RDCollection,(function(){this.filter((function(t){return t.$group}))})),this.on(this.State.$changes,"treeWidth",(function(i){e.Compact||t.$width===i||(t.define({width:i}),t.resize())})),this.on(this.app,"rdiagram:unit:change",(function(t){return e.ShowInUnits(t)})),this.on(this.app,"onScalesUpdate",(function(t){var i=e.Tree.columnId(0);e.Tree.getColumnConfig(i).header[0].height=t.height,e.Tree.refreshColumns()}))},e.prototype.RestoreTreeState=function(){var t=this;if(this._treeOpened&&this._treeOpened.length){var e=this._treeOpened,i=this.Tree.data.getBranch("0");i.forEach((function(r){var n=i.indexOf(r);r.open=!e.indexOf(n),t.Tree.data.callEvent("onStoreUpdated",[r.id,0,"branch"])}))}else this.Tree.openAll()},e.prototype.TreeTemplate=function(t,e){var i=this.Compact&&this._collapsed;return 1==t.$level?i?e.icon(t):e.treetable(t,e)+t.category:i?this.Helpers.resourceAvatar(t):e.space(t)+this.Helpers.resourceAvatar(t)+t.name},e.prototype.ShowInUnits=function(t){this._unit=t;var e=this.Tree,i=e.config.columns,r=i[i.length-1].fillspace;this.Compact&&this._collapsed||e.showColumnBatch(t),this.SetColumns(0,r)},e.prototype.NormalizeColumns=function(t,e){e&&this.SetColumns(this.Tree.getColumnIndex(t),!0)},e.prototype.SetColumns=function(t,e){var i=this.Tree.config.columns,r=i.length-1;0===t?(i[r].fillspace=e,i[r].width=0,i[r].resize=!1):t===r&&(i[0].fillspace=!0,i[0].width=0),this.Tree.refreshColumns()},e.prototype.ToggleColumns=function(){var t=this.Tree,e=t.isColumnVisible("load"),i=t.isColumnVisible("count"),r=this._collapsed=e||i;r?(e&&t.hideColumn("load"),i&&t.hideColumn("count")):"hours"===this._unit?t.showColumn("load"):t.showColumn("count"),t.config.width=r?44:0,t.config.columns[0].minWidth=r?44:150,t.resize(),t.refreshColumns(),this.app.callEvent("rdiagram:tree:toggle",[r])},e.prototype.ToggleBranch=function(t,e){var i=this,r=this.Tree.data.getBranch("0"),n=this.Tree.getState().open.filter((function(t){return r.find((function(e){return e.id==t}))}));this._treeOpened=n.map((function(t){return i.Tree.getIndexById(t)})),this.app.callEvent("rdiagram:branch:toggle",[t,e])},e.prototype.SortTasks=function(t,e,i){this.app.callEvent("rdiagram:sort",[t,e,i])},e}(u),ft=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._,i=this.getParam("compact",!0),r="contrast"===webix.skin.$name,n=this.app.getService("local").getScales().minUnit;return{type:r?"clean":"line",rows:[{view:"toolbar",borderless:r,elements:[{},{view:"radio",width:330,value:"hours",localId:"radio",options:[{id:"hours",value:e("Hours per")+" "+e(n)},{id:"tasks",value:e("Tasks per")+" "+e(n)}],on:{onChange:function(e){t.app.callEvent("rdiagram:unit:change",[e])}}}]},{type:"clean",cols:[dt,{view:i?"spacer":"resizer",css:"webix_gantt_resizer",width:i?1:4},{localId:"diagram",rows:[lt,ut]}]}]}},e.prototype.init=function(){var t=this,e=V({top:0});this.setParam("localState",e),this.on(this.app,"rdiagram:tree:toggle",(function(e){e?t.$$("diagram").show():t.$$("diagram").hide()}));var i=this.app.getService("locale")._,r=this.$$("radio");this.on(this.app,"onScalesUpdate",(function(t,e){t.minUnit!==e.minUnit&&(r.config.options.map((function(e){var r=e.value.split(" ");r[r.length-1]=i(t.minUnit),e.value=r.join(" ")})),r.refresh())}))},e}(u),gt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._,i={view:"treetable",css:"webix_gantt_tree webix_gantt_form_tree",header:!1,borderless:!0,localId:"links",autoheight:!0,editable:!0,scroll:!1,hover:"webix_gantt_link_table_hover",scheme:{$group:{by:"ttype"}},columns:[{id:"task",css:"webix_gantt_title",header:e("Task"),fillspace:!0,template:function(t){return t.$group?'<span class="webix_strong">'+e("source"==t.ttype?e("Successors"):e("Predecessors"))+"</span>":t.text||e("(no title)")}},{id:"type",css:"webix_gantt_type",header:e("Link"),width:140,template:function(t,e,i,r){return t.$group?"":r.collection.getItem(i).value+'<span class="webix_icon wxi-menu-down"></span>'},editor:"richselect",options:[{id:"0",value:e("End to start")},{id:"1",value:e("Start to start")},{id:"2",value:e("End to end")},{id:"3",value:e("Start to end")}]},{width:30,css:"webix_gantt_action",template:function(t){return t.$group?"":"<span class='webix_icon wxi-trash'></span>"}}],on:{onBeforeEditStart:function(t){return!this.getItem(t).$group},onBeforeEditStop:function(e,i){if(e.value!=e.old)return t.UpdateLink(i.row,{type:1*e.value}),!1},onAfterLoad:function(){this.openAll()}},onClick:{"wxi-trash":function(i,r){webix.confirm({title:e("Delete link"),text:e("The link will be deleted permanently, are you sure?")}).then((function(){return t.DeleteLink(r)}))}}};return{padding:{top:webix.skin.$active.layoutMargin.form,bottom:5},rows:[i]}},e.prototype.init=function(){var t=this;this.State=this.getParam("state",!0),this.Ops=this.app.getService("operations"),this.Links=this.$$("links"),this.on(this.State.$changes,"selected",(function(e){e&&t.FillData(e)}));var e=this.app.getService("local").links();this.on(e.data,"onStoreUpdated",(function(e,i){if(i){var r=t.State.selected;i.target!==r&&i.source!==r||t.FillData(r)}}))},e.prototype.FillData=function(t){var e=this.app.getService("local"),i=e.getLinks(t,"target").concat(e.getLinks(t,"source"));this.Links.clearAll(),i.length?(this.Links.parse(i),this.getRoot().show()):this.getRoot().hide()},e.prototype.UpdateLink=function(t,e){var i=this;this.Ops.updateLink(t,e).then((function(){i.Links.blockEvent(),i.Links.editCancel(),i.Links.unblockEvent(),e.type+="",i.Links.updateItem(t,e)}))},e.prototype.DeleteLink=function(t){var e=this;this.Ops.removeLink(t).then((function(){e.FillData(e.State.selected)}))},e}(u);webix.editors.gantt_numeditor=webix.extend({render:function(){var t=webix.editors.text.render.call(this),e=t.querySelector("input");return e.type="number",e.min=0,t}},webix.editors.text);var vt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this._=this.app.getService("locale")._;this.Local=this.app.getService("local"),this.Helpers=this.app.getService("helpers");var i=this.app.config,r=this.IsSingle="single"==i.resources||i.resourceCalendars,n={cols:[{view:"button",type:"icon",icon:"wxi-plus",autowidth:!0,localId:"addBtn",label:e("Add assignment"),click:function(){return t.AddBtnClickHandler()},css:"webix_transparent"},{}]},s={view:"treetable",css:"webix_gantt_resource_table webix_gantt_tree webix_gantt_form_tree",header:!1,borderless:!0,localId:"resources",autoheight:!0,editable:!0,editaction:"custom",scroll:!1,hover:"webix_gantt_table_hover",rowHeight:Math.max(webix.skin.$active.rowHeight,32),columns:[{id:"resource",css:"webix_gantt_title",fillspace:!0,template:function(e){return t.ResourceTemplate(e)},editor:"richselect",suggest:{width:250,css:"webix_gantt_select_editor_popup",padding:0,point:0,body:{width:250,type:{height:Math.max(webix.skin.$active.listItemHeight,32)},template:function(e){return r?t.OptionTemplate(e):t.EditorOptionTemplate(e)}}}},{id:"value",width:85,css:"webix_gantt_value",template:function(e){return t.ValueTemplate(e)},editFormat:function(t){return parseFloat(t)},editParse:function(t){return t=parseFloat(t),isNaN(t)?0:t},editor:"gantt_numeditor"},{id:"remove",width:30,css:"webix_gantt_action",template:function(e){return t.DeleteIconTemplate(e)}}],on:{onItemClick:function(e){t.Table.getItem(e).$group||"remove"==e.column||(t.Table.editRow(e),"value"==e.column&&t.Table.getEditor(e.row,"resource").getPopup().hide(),t.Table.getEditor(e.row,e.column).focus())},onBeforeEditStart:function(e){var i=t.Table.getItem(e.row);if(i.$group)return!1;if("resource"==e.column){t.Table.addCellCss(e.row,e.column,"webix_gantt_select_editor");var n=e&&!r?i.resource:null;t.FilterOptions(n)}return!0},onAfterEditStart:function(e){if("value"==e.column){var i=t.Table.getItem(e.row),r=t.Table.getEditor(e.row,"value").getInputNode(),n=t.GetRange(i);n&&t.ApplyEditorLimits(r,n);var s=t.GetValueStep(i);s&&t.ApplyEditorStep(r,s)}},onBeforeEditStop:function(e,i){if(t.Table.removeCellCss(i.row,"resource","webix_gantt_select_editor"),e.value!=e.old){var r={};if(r[i.column]=e.value,"value"==i.column){var n=t.Table.getItem(i.row),s=t.GetRange(n);s?t.ApplyValueRange(r,s):r.value<0&&(r.value=0),i.getInputNode().value=r.value}t.UpdateAssignment(i.row,r)}return!0},onAfterLoad:function(){this.openAll()}},onClick:{webix_gantt_remove_icon:function(i,r){webix.confirm({title:e("Delete assignment"),text:e("Are you sure to delete this assignment?")}).then((function(){return t.RemoveAssignment(r.row)}))}}};return r||(s.scheme={$group:{by:"category"}}),{margin:webix.skin.$active.layoutMargin.form,padding:{top:webix.skin.$active.layoutMargin.form,bottom:5},rows:[s,n]}},e.prototype.init=function(){var t=this;if(this.State=this.getParam("state",!0),this.Ops=this.app.getService("operations"),this.Helpers=this.app.getService("helpers"),this.Table=this.$$("resources"),this.Local=this.app.getService("local"),this.Resources=this.Local.resources(),!this.app.config.resources)return!1;this.on(this.State.$changes,"selected",(function(e){e&&t.FillData(e)}))},e.prototype.FillData=function(t){var e=this;if("task"!=this.Local.tasks().getItem(t).type)return!1;this.Local.getAssignments(t).then((function(t){if(!e.getRoot())return!1;e.Table.clearAll(),e.Table.getColumnConfig("resource").collection=e.Resources,t.length?(e.Table.show(),e.Table.parse(e.GetData(t)),e.IsSingle&&e.$$("addBtn").disable()):(e.IsSingle&&e.$$("addBtn").enable(),e.Table.hide())}))},e.prototype.GetData=function(t){return t.sort(this.app.getService("operations").sortResources),t},e.prototype.FilterOptions=function(t){var e=[],i=t?this.Resources.getItem(t).category_id:null;this.Table.data.each((function(t){e.push(t.resource)})),this.Resources.filter((function(r){return(!i||r.category_id==i)&&(e.indexOf(r.id)<0||t&&r.id==t)}))},e.prototype.UpdateAssignment=function(t,e){var i=this,r=this.Table.$view.querySelector(".webix_gantt_select_editor");if(r){var n=1*r.getAttribute("aria-rowindex");this.Table.removeCellCss(this.Table.data.getIdByIndex(n-1),"resource","webix_gantt_select_editor")}this.Ops.updateAssignment(t,e).then((function(){i.CloseEditor(t,e)}))},e.prototype.GetRange=function(t){var e=this.Resources.getItem(t.resource);return this.Helpers.getResourceValueRange(e)},e.prototype.ApplyValueRange=function(t,e){t.value<e[0]?t.value=e[0]:t.value>e[1]&&(t.value=e[1])},e.prototype.ApplyEditorLimits=function(t,e){t.min=e[0],t.max=e[1]},e.prototype.GetValueStep=function(t){var e=this.Resources.getItem(t.resource);return this.Helpers.getResourceValueStep(e)},e.prototype.ApplyEditorStep=function(t,e){t.step=e},e.prototype.CloseEditor=function(t,e){this.Table.blockEvent(),this.Table.editCancel(),this.Table.unblockEvent(),this.Table.updateItem(t,e)},e.prototype.RemoveAssignment=function(t){var e=this;this.Ops.removeAssignment(t).then((function(){e.FillData(e.State.selected)}))},e.prototype.AddBtnClickHandler=function(){var t=this;this.FilterOptions(),webix.delay((function(){t.ShowPopup()}))},e.prototype.AddAssignment=function(t){var e=this;this.IsSingle&&this.$$("addBtn").disable(),this.Ops.addAssignment({resource:t.id,value:this.Helpers.getDefaultResourceValue(t),task:this.State.selected}).then((function(){e.FillData(e.State.selected)}))},e.prototype.ResourceTemplate=function(t){if(t.$group)return'<span class="webix_strong">'+t.category+"</span>";if(t.resource){var e=this.Resources.getItem(t.resource);return this.EditorTemplate(e)}return""},e.prototype.ValueTemplate=function(t){if(t.$group)return"";var e=t.value;return(isNaN(e)?this.Helpers.getDefaultResourceValue(t):e)+this.GetUnitName(t)},e.prototype.GetUnitName=function(t){return this._(this.Helpers.getResourceUnit(t))},e.prototype.DeleteIconTemplate=function(t){return t.$group?"":"<span class='webix_icon wxi-trash webix_gantt_remove_icon'></span>"},e.prototype.GetPopupConfig=function(){var t=this;return{view:"suggest",localId:"popup",width:320,padding:0,point:0,fitMaster:!1,borderless:!0,css:"webix_gantt_select_editor_popup",body:{view:"list",minHeight:28,type:{height:Math.max(webix.skin.$active.listItemHeight,32)},data:this.Resources,template:function(e){return t.OptionTemplate(e)},on:{onItemClick:function(e){t.AddAssignment(t.Resources.getItem(e)),t.Popup.hide()}}}}},e.prototype.ShowPopup=function(){this.Popup&&this.Popup.$view||(this.Popup=this.ui(this.GetPopupConfig()),this.SetPopupPlaceholder()),this.Popup.show(this.$$("addBtn").$view,{x:1})},e.prototype.SetPopupPlaceholder=function(t){this.Popup.getBody().$view.firstChild.setAttribute("placeholder",t||this._("No resources to add"))},e.prototype.OptionTemplate=function(t){return"<div class='webix_gantt_avatar_option_box'>"+('<div class="webix_gantt_avatar_box_inline">'+(this.Helpers.resourceAvatar(t)+("<div class='webix_gantt_editor_avatar_name'>"+t.name+"</div>"))+"</div>")+("<span class='webix_gantt_resource_section'>"+t.category+"</span>")+"</div>"},e.prototype.EditorTemplate=function(t){return'<div class="webix_gantt_avatar_box">'+this.Helpers.resourceAvatar(t)+" "+("<div class='webix_gantt_editor_avatar_name'>"+t.name+"</div>")+"<span class='webix_icon wxi-menu-down'></span></div>"},e.prototype.EditorOptionTemplate=function(t){return'<div class="webix_gantt_avatar_box">'+this.Helpers.resourceAvatar(t)+" "+("<div class='webix_gantt_editor_avatar_name'>"+t.name+"</div>")+"</div>"},e}(u),mt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this;this.Compact=this.getParam("compact",!0);var e=this.app.getService("locale")._;this.isResources=this.app.config.resources,this.State=this.getParam("state",!0);var i=webix.skin.$active,r={view:"toolbar",css:"webix_subbar",borderless:!0,padding:{left:i.layoutPadding.form-(i.inputHeight-20)/2,right:i.layoutPadding.form},elements:[{view:"icon",icon:"wxi-close",click:function(){return t.Close()}},{},{view:"button",width:130,css:"webix_primary",value:e("Done"),click:function(){return t.Done()}}]},n={css:"webix_gantt_datepicker",type:"calendar",body:{height:270,width:250,icons:!0,events:function(e){return t.app.config.isHoliday(e)&&"webix_cal_event"}}},s=[{id:"task",value:e("Task")},{id:"milestone",value:e("Milestone")}];this.app.config.projects||s.splice(1,0,{id:"project",value:e("Project")});var a=[];this.app.config.links&&a.push({header:e("Related tasks"),body:gt,collapsed:!0}),this.isResources&&a.push({localId:"resourcesItem",header:"single"==this.isResources||this.app.config.resourceCalendars?e("Assignment"):e("Assignments"),body:{$subview:vt,name:"resources"},collapsed:!0,hidden:!0});var o={multi:!0,view:"accordion",borderless:!0,type:"clean",margin:10,css:"webix_gantt_accordion",rows:a};return{view:"proxy",body:{margin:0,padding:{bottom:14},rows:[r,{view:"form",localId:"form",borderless:!0,autoheight:!1,scroll:!0,elementsConfig:{labelPosition:"top"},elements:[{view:"text",name:"text",label:e("Title")},{view:"richselect",localId:"types",name:"type",label:e("Type"),options:s,on:{onChange:function(e){return t.ToggleControls(e)}}},{view:"datepicker",name:"start_date",label:e("Start date"),suggest:webix.copy(n)},{view:"datepicker",name:"end_date",label:e("End date"),suggest:webix.copy(n)},{view:"counter",name:"duration",css:"webix_gantt_form_counter",min:1,max:1e3,label:e("Duration")},{view:"slider",name:"progress",title:webix.template("#value#%"),label:e("Progress")},o,{view:"textarea",name:"details",label:e("Notes"),height:150}],on:{onChange:function(e,i,r){t.Compact?t.UpdateTaskTime():"user"==r&&t.UpdateTask().then((function(){"type"!==t._eventSource||"user"!==r||"split"!==e&&"split"!==i||t.Tasks.data.callEvent("onStoreUpdated",[])}))}}}]}}},e.prototype.init=function(){var t=this;this.Ops=this.app.getService("operations"),this.Local=this.app.getService("local"),this.Tasks=this.Local.tasks(),this.Form=this.$$("form"),this.on(this.State.$changes,"selected",(function(e){e&&t.FillData(e)})),this.on(this.Tasks.data,"onStoreUpdated",(function(e,i,r){"update"==r&&e==t.State.selected&&t.FillData(t.State.selected)})),this.on(this.State.$changes,"display",(function(e){var i=t.$$("form").elements.type;"tasks"==e?i.enable():"resources"==e&&i.disable()})),this.app.config.resourceCalendars&&this.on(this.Local.assignments().data,"onStoreUpdated",(function(){return t.SetResourceHolidays()}))},e.prototype.FillData=function(t){var e=this.Tasks.getItem(t),i=this.$$("types").getList();this.app.config.split&&e.$count?i.exists("split")||i.add({id:"split",value:this.app.getService("locale")._("Split task")}):i.exists("split")&&i.remove("split"),this.app.config.projects&&this.LimitTypeOptions(e),this.app.config.resourceCalendars&&this.SetResourceHolidays(),this.isResources&&this.SetResourcesVisibility(e),this.Form.setValues(e),this.Form.focus()},e.prototype.SetResourcesVisibility=function(t){var e=this.$$("resourcesItem");if("task"==t.type){if(!e.isVisible()){var i=this.getSubView("resources");i&&i.FillData(t.id),e.show()}}else e.isVisible()&&e.hide()},e.prototype.LimitTypeOptions=function(t){var e=this.Form.elements.type;"project"===t.type?e.hide():e.show()},e.prototype.PrepareDates=function(t){var e=this._eventSource=this.Form.$eventSource.config.name,i=!0;return"duration"==e||"start_date"==e&&"project"==t.type?t.end_date=null:"end_date"==e||"start_date"==e?t.duration=null:i=!1,i},e.prototype.UpdateTaskTime=function(){var t=this.Form.getValues(),e=this.PrepareDates(t);if("type"===this._eventSource&&"split"!==t.type&&(t.open=t.opened=1),this.RemoveTagsFromText(t)&&(this.Form.blockEvent(),this.Form.setValues(t,!0),this.Form.unblockEvent()),e){var i=this._eventSource?this._eventSource.split("_")[0]:null;this.Ops.updateTaskDuration(t,i),this.Form.blockEvent(),this.Form.setValues(t,!0),this.Form.unblockEvent()}},e.prototype.RemoveTagsFromText=function(t){return("text"===this._eventSource||"details"===this._eventSource)&&(t[this._eventSource]=(t[this._eventSource]||"").replace(/(<[^>]+>|^\s+|\s+$)/gi,""),!0)},e.prototype.UpdateTask=function(){var t=this,e=this.State.selected,i=this.Form.getValues();this.Compact||(this.PrepareDates(i),this.RemoveTagsFromText(i));var r=this._eventSource?this._eventSource.split("_")[0]:null;return"type"===this._eventSource&&"split"!==i.type&&(i.open=i.opened=1),this._inProgress=this.Ops.updateTask(e,i,r),this._inProgress.finally((function(){return t._inProgress=null})),this._inProgress},e.prototype.ToggleControls=function(t){if(this.Form.elements.end_date.show(),this.Form.elements.duration.show(),this.Form.elements.progress.show(),this.Form.elements.end_date.enable(),this.Form.elements.duration.enable(),this.Form.elements.progress.enable(),"project"==t||"milestone"==t){var e="project"==t?"disable":"hide";this.Form.elements.end_date[e](),this.Form.elements.duration[e](),this.Form.elements.progress[e]()}},e.prototype.Close=function(){var t=this;if(this.Compact&&this.Form.isDirty()){var e=this.app.getService("locale")._;webix.confirm({text:e("Save changes?")}).then((function(){return t.Done(!0)}),(function(){return t.Back(!0)}))}else this.Back(!0)},e.prototype.Back=function(t){t?this.State.$batch({edit:null,selected:null}):this.State.edit=null},e.prototype.Done=function(t){var e=this;this.Compact&&this.Form.isDirty()?this._inProgress?this._inProgress.then((function(){e.Back(t)})):this.UpdateTask().then((function(){return e.Back(t)})):this.Back(t)},e.prototype.SetResourceHolidays=function(){var t=this,e=[],i=this.Form.elements,r=this.app.getService("helpers");e.push(i.start_date,i.end_date);var n=this.Local.getTaskCalendar(this.State.selected);e.forEach((function(e){var i=e.getPopup().getBody();i.config.events=function(e){return(n?r.isResourceHoliday(e,n):t.app.config.isHoliday(e))&&"webix_cal_event"},i.refresh()}))},e}(u),yt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this._=this.app.getService("locale")._,i=this.getParam("state",!0),r={view:"button",width:130,label:e("Edit"),css:"webix_primary",click:function(){return t.EditTask()}},n=webix.skin.$active,s={view:"toolbar",css:"webix_subbar",borderless:!0,padding:{left:n.layoutPadding.form-(n.inputHeight-20)/2,right:n.layoutPadding.form},elements:[{view:"icon",icon:"wxi-close",click:function(){return t.Close()}},{},i.readonly?{}:r]},a={localId:"text",view:"template",css:"webix_gantt_task_info",template:function(e){return t.InfoTemplate(e)},borderless:!0},o={view:"button",label:e("Delete task"),css:"webix_danger webix_gantt_danger",align:"center",inputWidth:330,click:function(){webix.confirm({title:e("Delete task"),text:e("The task will be deleted permanently, are you sure?")}).then((function(){return t.DeleteTask()}))}};return{view:"proxy",body:{margin:0,rows:[s,{type:"form",borderless:!0,rows:[a,i.readonly?{}:o]}]}}},e.prototype.init=function(){var t=this;this.State=this.getParam("state",!0),this.Local=this.app.getService("local"),this.Tasks=this.Local.tasks(),this.Text=this.$$("text"),this.isResources=this.app.config.resources,this.on(this.State.$changes,"selected",(function(e){e&&t.FillTemplate(e)})),this.on(this.Tasks.data,"onStoreUpdated",(function(e,i,r){"update"==r&&e==t.State.selected&&t.FillTemplate(t.State.selected)}));var e=this.Local.links();this.on(e.data,"onStoreUpdated",(function(e,i){if(i){var r=t.State.selected;i.target!==r&&i.source!==r||t.FillTemplate(r)}})),this.isResources&&this.on(this.Local.assignments().data,"onStoreUpdated",(function(e,i){i&&i.task==t.State.selected&&t.FillTemplate(i.task)}))},e.prototype.FillTemplate=function(t){var e=this,i=webix.copy(this.Tasks.getItem(t));i.sources=this.Local.getLinks(t,"source"),i.targets=this.Local.getLinks(t,"target"),this.isResources&&"task"==i.type?this.Local.getAssignments(t).then((function(t){if(!e.getRoot())return!1;i.resources=t.sort(e.app.getService("operations").sortResources),e.Text.setValues(i)})):this.Text.setValues(i)},e.prototype.EditTask=function(){this.State.edit=!0},e.prototype.DeleteTask=function(){this.app.getService("operations").removeTask(this.State.selected),this.Close()},e.prototype.Close=function(){this.State.$batch({edit:null,selected:null})},e.prototype.InfoTemplate=function(t){if(!t.start_date)return"";var e=this.app.getService("locale")._,i=e("(no title)"),r='\n\t\t\t<span class="webix_gantt_task_title">'+(t.text||i)+'</span><br><br>\n\t\t\t<span class="webix_strong">'+e("Start date")+"</span>: "+this.DateFormat(t.start_date)+"<br>";if("milestone"!==t.type&&(r+='<span class="webix_strong">'+e("End date")+"</span>: "+this.DateFormat(t.end_date)+'<br>\n\t\t\t<span class="webix_strong">'+e("Duration")+"</span>: "+t.duration+'<br>\n\t\t\t<span class="webix_strong">'+e("Progress")+"</span>: "+t.progress+"%\n\t\t<br>"),t.targets.length&&(r+=this.InfoTemplateChunk(t.targets,e("Predecessors"),i)),t.sources.length&&(r+=this.InfoTemplateChunk(t.sources,e("Successors"),i)),t.resources){var n="single"==this.isResources||this.app.config.resourceCalendars;r+=this.ResourcesTemplateChunk(t.resources,e(n?"Assignment":"Assignments"))}return t.details&&(r+='<br><br><div class="webix_gantt_task_title">'+e("Notes")+'</div>\n\t\t\t\t<br><div class="webix_gantt_task_text">'+t.details.replace(/(?:\r\n|\r|\n)/g,"<br>")+"</div>"),r},e.prototype.ResourcesTemplateChunk=function(t,e){var i=this;if(!t||!t.length)return"";var r=130;return t.forEach((function(t){var e=webix.html.getTextSize(t.name,"webix_gantt_info_list_text"),i=webix.html.getTextSize(t.category,"webix_gantt_info_list_text webix_gantt_resource_section");r=Math.max(r,e.width,i.width)})),r=Math.min(200,r),'<br><span class="webix_strong">'+e+'</span>:<br><ul class="webix_gantt_info_list_resources">'+t.map((function(t){var e=i.app.getService("helpers"),n="<div>"+e.resourceAvatar(t,"webix_gantt_person_avatar_big")+"</div>",s="<div class=' webix_gantt_info_list_text webix_gantt_resource_section' style='min-width:"+r+"px'>"+t.category+"</div>",a="<div class='webix_gantt_resource_section'>"+t.value+i._(e.getResourceUnit(t))+"</div>";return"<div class='webix_gantt_info_resource'>"+n+("<div  >"+("<div class='webix_gantt_info_list_text_row'><div class='webix_gantt_info_list_text' style='min-width:"+r+"px'>"+t.name+"</div>"+a+"</div>")+s+"</div>")+"</div>"})).join("")+"</ul>"},e.prototype.InfoTemplateChunk=function(t,e,i){return'<br><span class="webix_strong">'+e+"</span>:<br><ul>"+t.map((function(t){return"<li>"+(t.text||i)+"</li>"})).join("")+"</ul>"},e.prototype.DateFormat=function(t){return webix.i18n.longDateFormatStr(t)},e}(u),_t=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){return{view:"window",fullscreen:!0,head:!1,body:{$subview:!0}}},e}(u),wt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.State=this.getParam("state",!0);this.Local=this.app.getService("local");var i=this.Local.getScales(),r=this._=this.app.getService("locale")._,n=this.Compact=this.getParam("compact",!0);this.isResources=this.app.config.resources,this.maxAvatarNumber=3;var s={id:"action",css:"webix_gantt_action",header:{text:'<span webix_tooltip="'+r("Add task")+'" class="webix_icon wxi-plus-circle"></span>',css:"webix_gantt_action"},template:function(){return'<span webix_tooltip="'+r("Add task")+'" class="webix_icon wxi-plus"></span>'},width:44,minWidth:44},a=[{id:"text",css:"webix_gantt_title",header:r("Title"),template:function(e,i){return i.treetable(e,i)+t.TitleTemplate(e)},fillspace:!0,hidden:n,batch:"full",sort:ht("text"),minWidth:150},{id:"start_date",header:r("Start date"),format:webix.i18n.dateFormatStr,hidden:n,batch:"full",sort:"date",minWidth:100}];this.isResources&&a.push({id:"resources",css:"webix_gantt_tree_column_resources",header:r("Assigned"),template:function(e){return t.ResourcesTemplate(e)},minWidth:100}),n?(s.header.text="<span class='webix_icon gti-menu'>",e.readonly&&(s.template=""),a.unshift(s)):e.readonly||a.push(s),a[a.length-1].resize=!1;var o={view:"treetable",css:"webix_gantt_tree webix_header_border",prerender:!0,width:n?44:e.treeWidth,rowHeight:i.cellHeight,headerRowHeight:i.height,scroll:"xy",scrollAlignY:!1,select:"row",sort:"multi",resizeColumn:{headerOnly:!0,size:10},drag:!e.readonly&&"order",columns:a,tooltip:function(){return""},onClick:{"wxi-plus":function(e,i){return t.AddTask(i.row)},"wxi-plus-circle":function(){return t.AddTask("0")},"gti-menu":function(){return t.ToggleColumns()}},on:{onBeforeOpen:function(e){return t.HandleToggle(e)},onAfterOpen:function(e){t.ToggleBranch(e,1),t.ApplySelection()},onAfterClose:function(e){return t.ToggleBranch(e,0)},onBeforeSelect:function(e){return t.BeforeSelectHandler(e)},onItemClick:function(e){return t.ItemClickHandler(e)},onAfterSort:function(e,i,r){return t.SortTasks(e,i,r)},onColumnResize:function(e,i,r,n){return t.NormalizeColumns(e,n)},onBeforeDrag:function(e,i){return t.BeforeDragHandler(e,i)},onBeforeDrop:function(e){return t.BeforeDropHandler(e)},onViewResize:function(){t.State.treeWidth=t.Tree.$width}}},l=function(){e.top=this.getScrollState().y};return webix.env.touch?o.on.onSyncScroll=o.on.onAfterScroll=l:o.on.onScrollY=l,o},e.prototype.init=function(t){var e=this;this.Tree=t,this.State=this.getParam("state",!0),this.Ops=this.app.getService("operations"),this.Helpers=this.app.getService("helpers"),this.Tasks=this.Local.tasks(),this.on(this.State.$changes,"display",(function(t){e.Mode=t,e.State.top=0,e.SyncData()})),this.isResources&&(this.on(this.Assignments.data,"onStoreUpdated",(function(){e.Tree.refresh()})),this.on(this.Tree.data,"onStoreUpdated",(function(t){"resources"!=e.Mode||t||e.ApplySelection()}))),this.on(this.State.$changes,"top",(function(t){return e.Tree.scrollTo(null,t)})),this.on(this.State.$changes,"selected",(function(t){t?e.ApplySelection():e.Tree.unselect()})),this.on(this.app,"onScalesUpdate",(function(t){var i=e.Tree.columnId(0);e.Tree.getColumnConfig(i).header[0].height=t.height,e.Tree.refreshColumns()})),this.on(this.app,"task:add",(function(t,i){return e.AddTask(t||"0",i)})),this.on(this.State.$changes,"treeWidth",(function(i){e.Compact||t.$width===i||(t.define({width:i}),t.resize())}))},e.prototype.HandleToggle=function(t){var e=this.Tree.getItem(t);if("split"===e.type&&e.$data.length)return!1},e.prototype.ItemClickHandler=function(t){this.Tree.getItem(t).$group?this.app.callEvent("edit:stop"):this.State.$batch({parent:null,selected:t.row})},e.prototype.BeforeSelectHandler=function(t){return!this.Tree.getItem(t).$group},e.prototype.BeforeDragHandler=function(t,e){if("tasks"==this.Mode){var i=this.Tree.getItem(t.start);if("split"===i.type&&i.$data.length){var r=this.Tree.$dragHTML(this.Tree.getItem(t.start),e,t);t.html=r.replace("webix_dd_drag","webix_dd_drag webix_gantt_tree_no_icon")}return!0}return!1},e.prototype.BeforeDropHandler=function(t){return this.Ops.moveTask(t.start,t.parent,t.index),!1},e.prototype.SyncData=function(){var t=this;this.Tree.clearAll(),this.VisibleTasks=this.Local.getVisibleTasksCollection();var e=[this.VisibleTasks.waitData];this.isResources&&(this.Resources=this.Local.resources(),this.Assignments=this.Local.assignments(),e.push(this.Resources.waitData,this.Assignments.waitData)),webix.promise.all(e).then((function(){t.Tree.sync(t.VisibleTasks),t.ApplySelection(),t.ApplySorting()}))},e.prototype.ApplySelection=function(){var t=this.State.selected;if(t&&this.Tree.exists(t)&&this.Tree.getSelectedId()!=t){var e=void 0,i=this.Tree.getItem(t);if("tasks"===this.State.display){var r=i.parent,n=0!=r?this.Tree.getItem(r):null;n&&"split"===n.type?e=r:this.Local._isTaskVisible(i)&&(e=t)}else this.Local._isTaskVisible(i)&&(e=t);e&&(this.Tree.select(e),this.Tree.showItem(e))}},e.prototype.ApplySorting=function(){this.State.sort&&(this.Tree.data.blockEvent(),this.Tree.setState({sort:this.State.sort}),this.Tree.data.unblockEvent())},e.prototype.AddTask=function(t,e){var i=this;this.State.selected=null;var r,n=this.Tree.getItem(t),s=n?0:-1,a=this.GetNewTask(n,e);if("resources"==this.Mode&&n)r=this.AddTaskWithAssignment(a,t);else if(n&&e){var o=void 0;this.app.config.resources&&(o=this.Assignments.find((function(t){return t.task==n.id}))),r=o&&o.length?this.SplitTaskWithAssignment(a,s,t,n,o):this.Ops.splitTaskWithDnd(a,s,t,n)}else r=this.Ops.addTask(a,s,n?t:0);return this.app.callEvent("backend:operation",[r]),r.then((function(e){n&&"tasks"==i.Mode&&"split"!==n.type&&i.Tree.open(t),i.State.$batch({edit:!0,selected:e.id}),i.Tree.showItem(e.id)})),!1},e.prototype.GetNewTask=function(t,e){var i=this.GetDates(t,e),r=i.start,n=i.end;return{start_date:new Date(r),end_date:n||webix.Date.add(r,1,"day",!0),progress:0,text:""}},e.prototype.GetDates=function(t,e){if(e)return e;var i;if(t&&"split"===t.type){var r=t.$data&&t.$data.length?t.$data[0].end_date:t.end_date;i=N("day")(r,1)}else if(t)i=t.start_date;else{var n=this.Local.getScales();i=webix.Date.add(n.start,1,n.minUnit)}return{start:i,end:void 0}},e.prototype.AddTaskWithAssignment=function(t,e){var i=this;this.Tasks.data.blockEvent(),this.Assignments.data.blockEvent();var r="0";e&&(r=this.Tree.getItem(e).$group?"0":e);var n=0;return this.Tasks.data.branch[r]&&(n=this.Tasks.data.branch[r].length),this.Ops.addTask(t,n,r).then((function(r){t.id=r.id;for(var n=[],s=null;"0"!=e&&!s;)(s=i.Tree.getItem(e).resources)||(e=i.Tree.getParentId(e));return s&&s.length&&s.forEach((function(e){var r=i.Local.resources().getItem(e);n.push(i.Ops.addAssignment({resource:e,value:i.Helpers.getDefaultResourceValue(r),task:t.id}))})),n.length?webix.promise.all(n).then((function(){return r})):webix.promise.resolve(r)})).finally((function(){i.Tasks.data.unblockEvent(),i.Assignments.data.unblockEvent(),i.Tasks.data.callEvent("onStoreUpdated",[t.id,t,"add"])}))},e.prototype.SplitTaskWithAssignment=function(t,e,i,r,n){var s=this;return this.Ops.splitTaskWithDnd(t,e,i,r).then((function(t){if(t.sibling){for(var e=[],i=0;i<n.length;++i)e.push(s.Ops.updateAssignment(n[i].id,{task:t.sibling}).then((function(){return t})));return webix.promise.all(e).then((function(){return t}))}return t}))},e.prototype.RefreshTasks=function(){this.Tasks.data.callEvent("onStoreUpdated",[])},e.prototype.SortTasks=function(t,e,i){var r=webix.isArray(t)?t:{by:t,dir:e,as:i},n=this.Tree.getState().sort;this.VisibleTasks.sort(r),this.State.sort=n},e.prototype.ToggleColumns=function(){var t=this.Tree.isColumnVisible("text");this.Tree.showColumnBatch("full",!t),this.Tree.config.width=t?44:0,this.Tree.resize(),this.app.callEvent("bars:toggle",[t])},e.prototype.NormalizeColumns=function(t,e){if(e){var i=this.Tree,r=i.config.columns,n=i.getColumnIndex(t),s=r.length-1;"action"===r[s].id&&(s-=1),0===n?(r[s].fillspace=!0,r[s].width=0):n===s&&(r[0].fillspace=!0,r[0].width=0),i.refreshColumns()}},e.prototype.ToggleBranch=function(t,e){if("resources"!=this.State.display)this.RefreshTasks(),this.State.readonly||this.Ops.updateTask(t,{opened:e});else{var i=this.VisibleTasks;i.getItem(t).open=!!e,i.data.callEvent("onStoreUpdated",[t,0,"branch"])}},e.prototype.TitleTemplate=function(t){return t.text||(t.$group?this._("Unassigned"):this._("(no title)"))},e.prototype.ResourcesTemplate=function(t){var e=this;if(this.Assignments.count()&&this.Resources.count()){var i=[];return this.Assignments.data.each((function(r){r.task==t.id&&i.push(e.Resources.getItem(r.resource))})),i.sort(this.Ops.sortResources),this.GetAssignmentsHTML(i)}return""},e.prototype.GetAssignmentsHTML=function(t){var e=this,i="";if(t.length>this.maxAvatarNumber){var r=t.length-this.maxAvatarNumber+1,n=(t=t.splice(0,this.maxAvatarNumber)).pop(),s=this.Helpers.resourceAvatar(n),a="<div class='webix_gantt_cell_remain_num'>+"+r+"</div>";i=t.map((function(t){return""+e.Helpers.resourceAvatar(t,null,!0)})).join(""),i+="<div class='webix_gantt_cell_assigned_last'>"+s+a+"</div>"}else{if(i=t.map((function(t){return""+e.Helpers.resourceAvatar(t,null,!0)})).join(""),1==t.length)i+="<span class='webix_gantt_cell_assigned_text'>"+t[0].name.split(" ")[0]+"</span>"}return"<div class='webix_gantt_avatar_box'>"+i+"</div>"},e}(u);webix.protoUI({name:"r-layout",sizeTrigger:function(t,e,i){this._compactValue=i,this._compactWidth=t,this._compactHandler=e,this._checkTrigger(this.$view.width,i)},_checkTrigger:function(t,e){return!this._compactWidth||!(t<=this._compactWidth&&!e||t>this._compactWidth&&e)||(this._compactWidth=null,this._compactHandler(!e),!1)},$setSize:function(t,e){if(this._checkTrigger(t,this._compactValue))return webix.ui.layout.prototype.$setSize.call(this,t,e)}},webix.ui.layout);var bt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this;this.fCompact=this.getParam("forceCompact"),void 0!==this.fCompact&&this.setParam("compact",this.fCompact),this.Compact=this.getParam("compact"),this.State=this.getParam("state",!0);var e=this.Compact?{$subview:!0,name:"edit",popup:!0}:{view:"proxy",css:"webix_shadow_medium",borderless:!0,width:400,hidden:!0,localId:"edit",body:{$subview:!0,name:"edit"}},i=[wt,{view:this.Compact?"spacer":"resizer",css:"webix_gantt_resizer",width:this.Compact?1:4},ct];return this.app.config.resources?i=[{type:"clean",rows:[{type:"clean",cols:i,on:{onViewResize:function(){t.app.callEvent("rdiagram:resize",[])}}},{view:"resizer",css:"webix_gantt_resizer",localId:"rdResizer"},{view:"proxy",localId:"rdiagram",height:this.Compact?0:400,body:{$subview:!0,name:"rdiagram"}}]},e]:i.push(e),{view:"abslayout",css:"webix_gantt",cells:[{view:"undefined"==typeof fCompact?"r-layout":"layout",localId:"main",borderless:!0,relative:!0,type:"clean",cols:i},{css:"webix_gantt_absbutton",view:"icon",icon:"wxi-plus",localId:"add",hidden:!this.Compact||this.State.readonly,width:50,height:50,right:20,bottom:20,click:function(){t.app.callEvent("task:add",[])}}]}},e.prototype.init=function(t){var e=this;this.fCompact||this.$$("main").sizeTrigger(this.app.config.compactWidth,(function(t){return e.SetCompactMode(t)}),!!this.Compact),this.on(this.State.$changes,"selected",(function(t,i){t?e.ShowTask(e.State.edit?"form":"info"):i&&e.HideTask()})),this.on(this.State.$changes,"edit",(function(t){e.State.selected&&e.ShowTask(t?"form":"info")})),webix.extend(t,webix.ProgressBar),this.on(this.app,"backend:operation",(function(e){t.showProgress({type:"top",delay:2e3}),e.finally((function(){t.hideProgress()}))})),this.app.config.resources&&this.on(this.State.$changes,"resourcesDiagram",(function(t){t?(e.$$("rdiagram").show(),e.$$("rdResizer").show(),e.show("rdiagram",{target:"rdiagram"})):(e.$$("rdiagram").hide(),e.$$("rdResizer").hide(),e.show("_blank",{target:"rdiagram"}).then((function(){e.app.callEvent("rdiagram:resize",[])})))}))},e.prototype.ShowTask=function(t){t="task."+t,this.Compact?this.show("task.popup/"+t,{target:"edit"}):(this.$$("edit").show(),this.show(t,{target:"edit"}))},e.prototype.HideTask=function(){this.show("_blank",{target:"edit"}),this.Compact||this.$$("edit").hide()},e.prototype.SetCompactMode=function(t){var e=this;webix.delay((function(){e.State.$batch({top:0,left:0}),e.setParam("compact",t),e.refresh()}))},e}(u),xt={JetView:u};xt["chart/bars"]=ot,xt.chart=ct,xt["chart/scale"]=lt,xt["rdiagram/diagram"]=ut,xt.rdiagram=ft,xt["rdiagram/tree"]=dt,xt["task/form"]=mt,xt["task/info"]=yt,xt["task/links"]=gt,xt["task/popup"]=_t,xt["task/resources"]=vt,xt.top=bt,xt.tree=wt;var kt=function(){function t(t,e){this.app=t,this.state=t.getState();var i=webix.skin.$active,r=e.scaleStart||webix.Date.dayStart(new Date),n=e.scaleEnd||webix.Date.add(r,1,"month",!0);this.setScales(r,n,e.preciseTimeUnit,e.scaleCellWidth||80,i.barHeight-2*i.borderWidth,e.scales||[{unit:"day",step:1,format:"%d"}]),this.dateToLocalStr=webix.Date.dateToStr(webix.i18n.parseFormat)}return t.prototype.setScales=function(t,e,i,r,n,s){var a=this._scales;r?(this._scaleBase={width:r,height:n,scales:s},e=webix.Date.add(e,1,"day")):(r=this._scaleBase.width,n=this._scaleBase.height,s=this._scaleBase.scales),this._scales=K(t,e,i,r,n,s,this.app.config.isHoliday),this._taskHeight=this._scales.cellHeight-12;var o=this.getVisibleTasksCollection();o&&o.data.order.length&&("resources"===this.state.display?this.app.getService("grouping").refreshResourceTasks():this.refreshTasks(),this.refreshLinks()),this.app.callEvent("onScalesUpdate",[this._scales,a])},t.prototype.getScales=function(){return this._scales},t.prototype.getTaskHeight=function(){return this._taskHeight},t.prototype.adjustScale=function(t,e){var i=this.getScales();t=N(i.minUnit)(t,-1),e=N(i.minUnit)(e,1),(i&&i.start>t||i.end<e)&&this.setScales(i.start>t?t:i.start,i.end<e?e:i.end,i.precise)},t.prototype.tasks=function(){var t=this;if(this._tasks)return this._tasks;var e=this.app.getService("operations"),i=this._tasks=new webix.TreeCollection({on:{"data->onStoreLoad":function(){if(!t.app.config.scaleStart){var e=1/0,r=-1/0;if(i.data.each((function(i){i.start_date<e&&(e=i.start_date),i.end_date>r&&(r=i.end_date),t.app.config.projects&&i.$count&&(i.type="project")})),"object"==typeof e){var n=t.getScales();t.setScales(N(n.minUnit)(e,-1),N(n.minUnit)(r,1),n.precise)}}},"data->onStoreUpdated":function(e,i,r){e="update"==r?e:null,t.refreshTasks(e),t.refreshLinks(),!r&&t.state.criticalPath&&(t.app.config.links?t._links.waitData.then((function(){return t.showCriticalPath()})):t.showCriticalPath())}},scheme:{$change:function(i){i.start_date=webix.i18n.parseFormatDate(i.start_date),i.end_date=webix.i18n.parseFormatDate(i.end_date),i.type=i.type||"task",t.app.config.split||"split"!==i.type||(i.type="task"),e.updateTaskDuration(i),"split"===i.type?(i.open=i.opened=0,i.$css="webix_gantt_split_task"):(delete i.$css,i.open=i.opened?1*i.opened:0)},$sort:{by:"position",dir:"asc",as:"int"},$serialize:function(e){return t.taskOut(e)},$export:function(e){return t.taskOut(e)}}}),r=[this.app.getService("backend").tasks()];return this.app.config.resourceCalendars&&r.push(this.taskCalendarMap()),i.parse(webix.promise.all(r).then((function(e){return t.app.getService("grouping").getTreeData(e[0],0)}))),i},t.prototype.refreshTasks=function(t,e){var i=this;if(t){var r=this._tasks.getItem(t);(e=webix.isUndefined(e)?this._tasks.getIndexById(t):e)<0&&(e=this._tasks.getIndexById(r.parent)),"split"===r.type&&(r.$data=this._tasks.find((function(t){return t.parent==r.id})).sort((function(t,e){return e.start_date-t.start_date||e.end_date-t.end_date}))),Q(r,e,this._scales,this._taskHeight)}else this._tasks.data.order.forEach((function(t,e){i.refreshTasks(t,e)}))},t.prototype.links=function(){var t=this;if(this._links)return this._links;var e=this._links=new webix.DataCollection({on:{"data->onStoreUpdated":function(e,i,r){r&&t.refreshLinks(e)}},scheme:{$init:function(t){t.type=1*t.type}}});return this.app.config.links&&e.parse(this.app.getService("backend").links()),e},t.prototype.refreshLinks=function(t){var e=this,i=this.getVisibleTasksCollection();this._links&&i&&(this._links.data.each((function(t){var r=i.getItem(t.source),n=i.getItem(t.target);r&&n&&e._isTaskVisible(r)&&e._isTaskVisible(n)?Z(t,r,n,e._taskHeight):t.$p=""})),this.state.criticalPath&&t&&this.showCriticalPath())},t.prototype.getLinks=function(t,e){for(var i=this._links.find((function(i){return i[e]==t})),r=[],n=0;n<i.length;n++){var s=i[n],a=this._tasks.getItem(s["source"==e?"target":"source"]);a&&r.push({id:s.id,type:s.type.toString(),text:a.text,ttype:e})}return r},t.prototype.taskOut=function(t){t=webix.copy(t);var e=this.dateToLocalStr;for(var i in t.start_date&&(t.start_date=e(t.start_date)),t.end_date&&(t.end_date=e(t.end_date)),t)0===i.indexOf("$")&&delete t[i];return t},t.prototype._isTaskVisible=function(t,e){var i=this.getVisibleTasksCollection(e),r=t.$parent,n="split"===t.type&&!t.open;if(n&&!r)return!1;for(;t.$parent;)if(!(r==(t=i.getItem(t.$parent)).id&&"split"==t.type||t.open)||t.open&&n)return!1;return!0},t.prototype.categories=function(){if(this._categories)return this._categories;var t=this._categories=new webix.DataCollection({});return t.parse(this.app.getService("backend").categories()),t},t.prototype.resources=function(){var t=this;if(this._resources)return this._resources;var e=this._resources=new webix.DataCollection,i=[this.app.getService("backend").resources(),this.categories().waitData];return this.app.config.resourceCalendars&&i.push(this.calendars().waitData),e.parse(webix.promise.all(i).then((function(e){var i=e[0];return i.forEach((function(e){if(e.category_id){var i=t.categories().getItem(e.category_id);e.category=i.name,!e.unit&&i.unit&&(e.unit=i.unit)}})),i.sort(t.app.getService("operations").sortResources),i}))),e},t.prototype.assignments=function(){if(this._assignments)return this._assignments;var t=this._assignments=new webix.DataCollection({});return t.parse(this.app.getService("backend").assignments()),t},t.prototype.getAssignments=function(t){var e=this;return webix.promise.all([this.resources().waitData,this.assignments().waitData]).then((function(){var i=e.resources();return e.assignments().data.find((function(e){return e.task==t})).map((function(t){var e=Object.assign({},t),r=Object.assign({},i.getItem(t.resource));return delete r.id,Object.assign(e,r)}))}))},t.prototype.calendars=function(){if(this._calendars)return this._calendars;var t=this._calendars=new webix.DataCollection({scheme:{$change:function(t){"string"==typeof t.weekDays&&(t.weekDays=t.weekDays.split(",").map((function(t){return 1*t}))),t.holidays&&("string"==typeof t.holidays&&(t.holidays=t.holidays.split(",")),t.holidays=t.holidays.map((function(t){return webix.Date.datePart(new Date(t))})))}}});return t.parse(this.app.getService("backend").calendars()),t},t.prototype.showCriticalPath=function(t){var e=this;if(t)this._tasks.data.order.forEach((function(t){delete e._tasks.getItem(t).$critical}));else{var i=this._tasks.data.getRange().sort((function(t,e){return e.end_date-t.end_date||(t.parent==e.id?1:e.parent==t.id?-1:0)||e.start_date-t.start_date})),r=webix.Date.copy(i[0].end_date);i.forEach((function(t){t.$critical=e.isTaskCritical(t,r)}))}this._tasks.data.callEvent("onStoreUpdated",[null,null,"paint"])},t.prototype.isTaskCritical=function(t,e){if(e&&webix.Date.equal(e,t.end_date))return!0;for(var i=this._links.find((function(e){return e.source==t.id&&0==e.type})),r=0;r<i.length;++r){var n=this._tasks.getItem(i[r].target);if(n.$critical&&this.isNoSlack(n.start_date,t.end_date,t.id))return!0}if(0!=t.parent){var s=this._tasks.getItem(t.parent);return s.$critical&&t.end_date>=s.end_date}return!1},t.prototype.isNoSlack=function(t,e,i){if(this.app.config.excludeHolidays){if(e>=t)return!0;for(var r=webix.Date.copy(e);r<t;){if(!this.isHoliday(r,i))return!1;webix.Date.add(r,1,"day")}return!0}return e>=t},t.prototype.isLinkCritical=function(t){var e=!1;if(0==t.type){var i=this.tasks(),r=i.getItem(t.source),n=i.getItem(t.target);e=r&&n&&r.$critical&&n.$critical}return e},t.prototype.getVisibleTasksCollection=function(t){if(!t&&"resources"==this.state.display){var e=this.app.getService("grouping");return e?e.getResourceTree():null}return this._tasks},t.prototype.taskCalendarMap=function(t){var e=this;return t?this._calendarMap||null:(this._calendarMap||(this.assignments().data.attachEvent("onStoreUpdated",(function(){e.refreshCalendarMap()})),this.resources().data.attachEvent("onStoreUpdated",(function(){e.refreshCalendarMap()})),this.calendars().data.attachEvent("onStoreUpdated",(function(){e.refreshCalendarMap()}))),webix.promise.all([this.assignments().waitData,this.resources().waitData,this.calendars().waitData]).then((function(){return e._calendarMap||e.refreshCalendarMap(),e._calendarMap})))},t.prototype.refreshCalendarMap=function(){var t=this.resources(),e=this.calendars(),i={};return this.assignments().data.each((function(r){var n=t.getItem(r.resource);if(n){var s=n.calendar_id,a=s?e.getItem(s):null;a&&!i[r.task]&&(i[r.task]=a)}})),this._calendarMap=i},t.prototype.getTaskCalendar=function(t){var e=this.taskCalendarMap(!0);return e?e[t]:null},t.prototype.isHoliday=function(t,e){if(e&&this._calendarMap){var i=this._calendarMap[e];if(i)return this.app.getService("helpers").isResourceHoliday(t,i)}return this.app.config.isHoliday(t)},t}(),St=function(){function t(t,e){this.app=t,this._url=e}return t.prototype.url=function(t){return this._url+t},t.prototype.tasks=function(){return webix.ajax(this.url("tasks")).then((function(t){return t.json()}))},t.prototype.links=function(){return webix.ajax(this.url("links")).then((function(t){return t.json()}))},t.prototype.resources=function(){return webix.ajax(this.url("resources")).then((function(t){return t.json()}))},t.prototype.categories=function(){return webix.ajax(this.url("categories")).then((function(t){return t.json()}))},t.prototype.assignments=function(){return webix.ajax(this.url("assignments")).then((function(t){return t.json()}))},t.prototype.calendars=function(){return webix.ajax(this.url("calendars")).then((function(t){return t.json()}))},t.prototype.addTask=function(t,e,i){var n=webix.ajax().post(this.url("tasks"),r(r({},t),{mode:e,parent:i})).then((function(t){return t.json()}));return this.app.callEvent("backend:operation",[n]),n},t.prototype.removeTask=function(t){var e=webix.ajax().del(this.url("tasks/"+t)).then((function(t){return t.json()}));return this.app.callEvent("backend:operation",[e]),e},t.prototype.updateTask=function(t,e,i){var r=webix.ajax().put(this.url("tasks/"+t+(i?"/split":"")),e).then((function(t){return t.json()}));return this.app.callEvent("backend:operation",[r]),r},t.prototype.reorderTask=function(t,e){var i=webix.ajax().put(this.url("tasks/"+t+"/position"),e).then((function(t){return t.json()}));return this.app.callEvent("backend:operation",[i]),i},t.prototype.addLink=function(t){var e=webix.ajax().post(this.url("links"),t).then((function(t){return t.json()}));return this.app.callEvent("backend:operation",[e]),e},t.prototype.updateLink=function(t,e){var i=webix.ajax().put(this.url("links/"+t),e).then((function(t){return t.json()}));return this.app.callEvent("backend:operation",[i]),i},t.prototype.removeLink=function(t){var e=webix.ajax().del(this.url("links/"+t)).then((function(t){return t.json()}));return this.app.callEvent("backend:operation",[e]),e},t.prototype.addAssignment=function(t){var e=webix.ajax().post(this.url("assignments"),t).then((function(t){return t.json()}));return this.app.callEvent("backend:operation",[e]),e},t.prototype.updateAssignment=function(t,e){var i=webix.ajax().put(this.url("assignments/"+t),e).then((function(t){return t.json()}));return this.app.callEvent("backend:operation",[i]),i},t.prototype.removeAssignment=function(t){var e=webix.ajax().del(this.url("assignments/"+t)).then((function(t){return t.json()}));return this.app.callEvent("backend:operation",[e]),e},t}(),Tt=function(){function t(t){this.app=t,this._local=this.app.getService("local"),this._back=this.app.getService("backend"),this._state=this.app.getState()}return t.prototype.addTask=function(t,e,i,n){var s=this;this.updateTaskDuration(t,n);var a=0==e?"first":"last";return this._back.addTask(this.cleanData(t),a,i).then((function(n){return s._local.adjustScale(t.start_date,t.end_date),s._local.tasks().add(r(r({},t),{id:n.id,parent:i}),e,i),s.completeAdd(i,n)}))},t.prototype.splitTaskWithDnd=function(t,e,i,n){var s=this;return this.updateTaskDuration(t),this._back.updateTask(i,r(r({},t),{position:e,parent:i}),!0).then((function(a){s._local.adjustScale(t.start_date,t.end_date);var o=s._local.tasks();return o.updateItem(i,{type:"split",duration:n.duration||1,progress:n.progress||0}),(a.sibling&&0!=a.sibling||!o.find((function(t){return t.parent==i}),!0))&&(o.add(r(r({},n),{type:"task",parent:i,id:a.sibling,duration:n.duration||1,progress:n.progress||0}),0,i),++e),o.add(r(r({},t),{id:a.id,parent:i,position:e}),e,i),s.completeAdd(i,a,a.sibling)}))},t.prototype.completeAdd=function(t,e,i){var r=this;return t?this.syncProject(t).then((function(){return r._state.criticalPath&&r._local.showCriticalPath(),i&&(e.sibling=i),e})):webix.promise.resolve(e)},t.prototype.updateTask=function(t,e,i,n){var s=this,a=this._local.tasks(),o=webix.copy(a.getItem(t)),l=r(r({},o),e),c=!(webix.Date.equal(o.start_date,l.start_date)&&webix.Date.equal(o.end_date,l.end_date));return c&&this.updateTaskDuration(l,i),n||"project"!=l.type||"project"==o.type?this._back.updateTask(t,this.cleanData(l)).then((function(){var e=s._local.getScales(),i=e.start,r=e.end;if((i>l.start_date||r<l.end_date)&&s._local.adjustScale(l.start_date,l.end_date),a.updateItem(t,l),"task"!=l.type&&"task"==o.type&&s.removeAssignments(l),!n&&(c||o.progress!=l.progress||o.parent!=l.parent)){(o.$count&&"project"==o.type?s.syncTasks(t,o.start_date,l.start_date).then((function(){return s.syncProject(o.parent)})):o.parent!=l.parent?webix.promise.all([s.syncProject(l.parent),s.syncProject(o.parent)]):s.syncProject(l.parent)).then((function(){s._state.criticalPath&&(a.updateItem(t,{$critical:!1}),s._local.showCriticalPath())}))}return l})):this.syncProject(t,l)},t.prototype.updateTaskDuration=function(t,e){var i=this;if(this.app.config.excludeHolidays){var r=void 0;if(e){var n=(e="move"==e?"start":e)+("start"===e||"end"===e?"_date":"");r=this._local.tasks().getItem(t.id)[n]>t[n]?-1:1,"start"!=e&&(e="end")}var s=webix.copy(this._local.getScales());s.isHoliday=function(e){return i._local.isHoliday(e,t.id)},tt(t,s,e,r)}else tt(t)},t.prototype.syncTasks=function(t,e,i){var n=this,s=i-e;if(this.app.config.excludeHolidays&&(s=this.getWorkDateDiff(s,e,t)),s){var a=[];return this._local.tasks().data.eachSubItem(t,(function(t){var e=t.start_date.valueOf()+s;if(n.app.config.excludeHolidays){var i=s-n.getWorkDateDiff(s,t.start_date,t.id);i&&(e+=i)}var o=r(r({},t),{start_date:new Date(e),end_date:null});a.push(n.updateTask(t.id,o,"move",!0))})),webix.promise.all(a)}return webix.promise.resolve()},t.prototype.getWorkDateDiff=function(t,e,i){for(var r=Math.sign(t),n=r*Math.floor(t/864e5),s=0,a=e;s<n;++s)webix.Date.add(a,r,"day"),this._local.isHoliday(a,i)&&(t-=864e5*r);return t},t.prototype.syncProject=function(t,e){var i=this,r=this._local.tasks();if(!e)if(e=r.getItem(t),this.app.config.projects&&e&&"split"!=e.type)e.type=e.$count?"project":"task",this.removeAssignments(e);else for(;e&&"project"!=e.type;)t=r.getParentId(t),e=r.getItem(t);return e&&e.$count&&(e=this.setProjectData(e)),e?this.updateTask(t,e,"start",!0).then((function(){return i.syncProject(e.parent),e})):webix.promise.resolve()},t.prototype.setProjectData=function(t,e,i){i||(t=webix.copy(t));var r=1/0,n=0,s=0,a=0,o=function(t){r=t.start_date<r?t.start_date:r,n=t.end_date>n?t.end_date:n,!t.duration||"project"==t.type&&t.$count||(s+=t.duration*t.progress,a+=1*t.duration)};i?i.forEach(o):(e||this._local.tasks()).data.eachSubItem(t.id,o);return webix.Date.equal(t.start_date,r)||(t.start_date=r,t.duration=null),webix.Date.equal(t.end_date,n)||(t.end_date=n,t.duration=null),t.progress=s?Math.round(s/a):s,t},t.prototype.updateTaskTime=function(t,e,i){var r=this._local.tasks().getItem(t),n={},s=this._local.getScales(),a=s.precise?J[s.minUnit][0]:s.minUnit;if("start"===e||"move"===e){var o=s.precise?r.start_date:q(a,r.start_date);n.start_date=N(a)(o,i),"start"===e&&n.start_date>r.end_date&&(n.start_date=N(a)(r.end_date,-1))}else if("end"===e){var l=q(a,r.end_date);o=s.precise||webix.Date.equal(l,r.end_date)?r.end_date:N(a)(l,1);n.end_date=N(a)(o,i),n.end_date<r.start_date&&(n.end_date=N(a)(r.start_date,1))}return"move"===e?n.end_date=null:n.duration=0,this.updateTask(t,n,e)},t.prototype.removeTask=function(t){var e=this,i=this._local.tasks(),r=this._local.links();return r.find((function(e){return e.source==t||e.target==t})).forEach((function(t){return r.remove(t.id)})),this._back.removeTask(t).then((function(r){var n=i.getItem(t).parent;return i.remove(t),e.app.config.split&&0!=n&&"split"===i.getItem(n).type&&!i.find((function(t){return t.parent==n}),!0)?e.updateTask(n,{type:"task"}).then((function(){return e.completeRemoval(r,n)})):e.completeRemoval(r,n)}))},t.prototype.completeRemoval=function(t,e){var i=this;return this.syncProject(e).then((function(){return i._state.criticalPath&&i._local.showCriticalPath(),t}))},t.prototype.addLink=function(t){var e=this;return this.linkExists(t)?webix.promise.reject():this._back.addLink(t).then((function(i){return t.id=i.id,e._local.links().add(t),t}))},t.prototype.linkExists=function(t){return this._local.links().find((function(e){return e.target==t.target&&e.source==t.source&&e.type==t.type}),!0)},t.prototype.updateLink=function(t,e){var i=this;return this._back.updateLink(t,e).then((function(n){var s=i._local.links(),a=i.linkExists(r(r({},s.getItem(t)),e));return s.updateItem(t,e),a?i.removeLink(a.id).then((function(){return n})):n}))},t.prototype.removeLink=function(t){var e=this;return this._back.removeLink(t).then((function(i){return e._local.links().remove(t),i}))},t.prototype.moveTask=function(t,e,i){var r=this;e=e||0;var n=this._local.tasks(),s=n.data.branch[e],a=n.getItem(t).parent,o=n.data.getBranchIndex(t);return e==a&&(i===o||-1===i&&t===s[s.length-1])?webix.promise.reject():(n.move(t,i,null,{parent:e}),this._back.reorderTask(t,{parent:e,mode:0===i?"first":-1===i?"last":"after",target:n.data.branch[e][i-1]}).then((function(i){return e!==a?(n.updateItem(t,{parent:e}),webix.promise.all([r.syncProject(e),r.syncProject(a)]).then((function(){return r._state.criticalPath&&r._local.showCriticalPath(),i}))):i})))},t.prototype.updateAssignment=function(t,e){var i=this;return this._back.updateAssignment(t,e).then((function(r){return i._local.assignments().updateItem(t,e),r}))},t.prototype.addAssignment=function(t){var e=this;return this._back.addAssignment(t).then((function(i){return t.id=i.id,e._local.assignments().add(t),t}))},t.prototype.removeAssignment=function(t){var e=this;return this._back.removeAssignment(t).then((function(i){return e._local.assignments().remove(t),i}))},t.prototype.sortResources=function(t,e){return t.category==e.category?t.name>e.name?1:-1:t.category>e.category?1:-1},t.prototype.removeAssignments=function(t){var e=this;if(this.app.config.resources){var i=this._local.assignments(),r=[];return i.waitData.then((function(){return i.data.each((function(i){i.task==t.id&&r.push(e.removeAssignment(i.id))})),r.length?webix.promise.all(r):webix.promise.resolve(!1)}))}return webix.promise.resolve(!1)},t.prototype.cleanData=function(t){var e={};for(var i in t)0!==i.indexOf("$")&&(e[i]=t[i]);return e},t.prototype.updateAssignedTaskDates=function(t){var e=webix.copy(t);this.updateTaskDuration(e),!(webix.Date.equal(t.start_date,e.start_date)&&webix.Date.equal(t.end_date,e.end_date))&&this.updateTask(t.id,e,null,!0)},t}(),$t=function(){function t(){this.defaultResourceUnit="hour",this.defaultResourceValues={hour:8},this.resourceValueRanges={hour:[.5,24]},this.resourceValueSteps={hour:.5},this.unitLoadNorm={day:8,week:40,month:170,quarter:510,year:2040}}return t.prototype.initials=function(t){var e=t.match(/\b\w/g)||[];return 1==e.length?t.charAt(0).toUpperCase()+t.charAt(1):((e.shift()||"")+(e.pop()||"")).toUpperCase()},t.prototype.avatarCss=function(t){return" webix_gantt_person_avatar_"+(t.charCodeAt(1)+t.length%10)%10},t.prototype.resourceAvatar=function(t,e,i){var r="webix_gantt_person_avatar";if("string"==typeof e&&(r+=" "+e),t.avatar)return'<img class="'+r+'" src="'+t.avatar+'" webix_tooltip="'+(i?t.name:"")+'"/>';var n=t.name;return"<div class='"+r+" "+(n?this.avatarCss(n):"")+"' webix_tooltip=\""+(i?t.name:"")+'">'+(n?this.initials(n):"")+"</div>"},t.prototype.getDefaultResourceValue=function(t){var e=this.getResourceUnit(t);return this.defaultResourceValues[e]},t.prototype.getResourceUnit=function(t){return t.unit||this.defaultResourceUnit},t.prototype.getResourceValueRange=function(t){var e=this.getResourceUnit(t);return this.resourceValueRanges[e]||[1,100]},t.prototype.getResourceValueStep=function(t){var e=this.getResourceUnit(t);return this.resourceValueSteps[e]||null},t.prototype.isResourceHoliday=function(t,e){var i=!1;return e.holidays&&(i=e.holidays.find((function(e){return e.getTime()==t.getTime()}))),e.weekDays&&(i=i||-1==e.weekDays.indexOf(t.getDay())),i},t}(),Ct=function(){function t(t){this.app=t,this.local=t.getService("local"),this.helpers=t.getService("helpers"),this.closedResources=null}return t.prototype.getTreeData=function(t,e){var i=this,r=t.filter((function(t){return t.parent==e}));return r.forEach((function(e){var r=i.getTreeData(t,e.id);r&&(e.data=r)})),r},t.prototype.getRDCollection=function(){var t=this;if(this._rdCollection)return this._rdCollection;var e=this.local.tasks(),i=this.local.assignments(),r=this.local.resources(),n=this._rdCollection=new webix.TreeCollection({});return webix.extend(n,webix.Group),this.syncRDWithData(),webix.promise.all([e.waitData,i.waitData,r.waitData]).then((function(){var e=[],r=t.local.getScales();i.data.each((function(i){var n=t.getDiagramItemData(i,r);n&&e.push(n)})),n.parse(e),t.groupResourceDiagram()})),n},t.prototype.syncRDWithData=function(){var t=this;this.app.on("onScalesUpdate",(function(e,i){t._rdCollection&&t._rdCollection.data.order.length&&(t.refreshTaskDiagram(),e.minUnit!==i.minUnit&&(t.updateUnitDurations(),t.groupResourceDiagram()))})),this.local.tasks().data.attachEvent("onStoreUpdated",(function(e,i,r){r&&i&&("update"==r||"delete"==r||t.local.assignments().find((function(t){return t.task===i.id}),!0))&&(t.updateTaskDiagram(i,r),t.groupResourceDiagram())})),this.local.assignments().data.attachEvent("onStoreUpdated",(function(e,i,r){e&&(t.refreshResourceDiagram(e,i,r),t.groupResourceDiagram())}))},t.prototype.updateUnitDurations=function(){var t=this,e=this.local.tasks(),i=this.local.assignments(),n=this.local.getScales();this._rdCollection.data.each((function(s){if(s.task){var a=e.getItem(s.task),o=i.getItem(s.id);a&&o&&(s.duration=t.calculateUnitDuration(a,n),s.value=t.calculateLoad(r(r({},a),o),n.minUnit))}}))},t.prototype.calculateUnitDuration=function(t,e){return"day"===e.minUnit?t.duration:e.diff(t.end_date,t.start_date,!1,!0)},t.prototype.getDiagramItemData=function(t,e){var i=this.local.tasks().getItem(t.task);if(i){this.local._isTaskVisible(i,!0)||Q(i,0,e,this.local.getTaskHeight());var n=this.local.resources().getItem(t.resource),s=r(r(r({},i),n),t);return s.duration=this.calculateUnitDuration(i,e),s.value=this.calculateLoad(s,e.minUnit),s.$x=this.truncateX(s.$x,e),s}return null},t.prototype.calculateLoad=function(t,e){if("hour"===e)return[0,0,1];var i=this.getUnitLoad(t);if("day"===e)return[0,0,i];var r,n=[],s=webix.Date.copy(t.start_date),a=q(e,s),o=webix.Date.copy(t.end_date),l=q(e,o);if(webix.Date.datePart(s,!0)>a)if(o>(r=N(e)(a,1))){var c=this.findUnitDuration(s,r,t);n.push(c),s=r}else n.push(0);else n.push(0);if(!webix.Date.equal(a,l)&&webix.Date.datePart(o,!0)>=l){var u=this.findUnitDuration(l,o,t);n.push(u),o=l}else n.push(0);var h=N(e)(s,1),p=this.findUnitDuration(s,new Date(Math.min(h,o)),t);return n.push(p),n.map((function(t){return t*i}))},t.prototype.findUnitDuration=function(t,e,i){var r=G("day")(e,t);if(this.app.config.excludeHolidays){var n=void 0,s=webix.Date.copy(t),a=r;for(n=0;n<a;n++)this.checkHoliday(s,i)&&r--,webix.Date.add(s,1,"day")}return r},t.prototype.checkHoliday=function(t,e){if(this.app.config.resourceCalendars){var i=this.local.resources().getItem(e.resource).calendar_id;if(i){var r=this.local.calendars().getItem(i);return this.helpers.isResourceHoliday(t,r)}}return this.app.config.isHoliday(t)},t.prototype.getUnitLoad=function(t){return t.value},t.prototype.truncateX=function(t,e){return!1!==e.precise?Math.floor(t/e.cellWidth)*e.cellWidth:t},t.prototype.refreshResourceDiagram=function(t,e,i){var n=this._rdCollection,s=this.local.getScales();switch(i){case"update":if(n.exists(t)){var a=this.local.tasks().getItem(e.task),o=r({},this.local.resources().getItem(e.resource));delete o.id;var l=this.calculateLoad(r(r({},a),e),s.minUnit);n.updateItem(t,r(r(r({},e),o),{value:l}))}break;case"add":n.add(this.getDiagramItemData(e,s));break;case"delete":n.exists(t)&&n.remove(t)}},t.prototype.updateTaskDiagram=function(t,e){var i=this,n=this._rdCollection,s=this.local.getScales();if("delete"===e)this.pruneDiagram();else if("add"===e){var a=this.local.assignments().find((function(e){return e.task===t.id}),!0);n.add(this.getDiagramItemData(a,s))}else if("update"===e){n.find((function(e){return e.task===t.id})).forEach((function(e){var a=i.local.assignments().getItem(e.id);n.updateItem(e.id,{start_date:t.start_date,id:e.id,duration:i.calculateUnitDuration(t,s),$x:i.truncateX(t.$x,s),value:i.calculateLoad(r(r({},t),a),s.minUnit)})}))}},t.prototype.pruneDiagram=function(){var t=this.local.tasks(),e=[];this._rdCollection.data.eachLeaf(0,(function(i){t.exists(i.task)||e.push(i.id)})),e.length&&this._rdCollection.remove(e)},t.prototype.refreshTaskDiagram=function(){var t=this,e=this.local.getScales();this._rdCollection.data.each((function(i){var r=t.local.tasks().getItem(i.task);r&&(i.$x=t.truncateX(r.$x,e))}))},t.prototype.groupResourceDiagram=function(){var t=this._rdCollection;t.group({by:function(t){return t.name+"-"+t.category},map:{resource_id:["resource"],value:["name"],name:["name"],category:["category"],avatar:["avatar"],load:["value",Rt],duration:["duration",Dt],units:["value",Dt],$x:["$x",Dt],count:["value","count"],start_date:["start_date",Dt]}}),t.group({by:"category",map:{value:["category"],name:["category"],duration:["duration","sum"],load:["load","sum"],count:["count","sum"]}},0)},t.prototype.getResourceTree=function(){var t=this;if(this._resourcesTree)return this._resourcesTree;var e=this._resourcesTree=new webix.TreeCollection({on:{"data->onStoreUpdated":function(e,i,r){e="update"==r||"paint"==r?e:null,t.refreshResourceTasks(e),t.local.refreshLinks()}},scheme:{$sort:{by:"start_date",dir:"asc",as:"int"}}});return this._resourcesTree.parse(this.resourceTaskLoader().finally((function(){t.syncResourceTree()}))),e},t.prototype.tasksWithResources=function(){var t=this;return webix.promise.all([this.local.tasks().waitData,this.local.assignments().waitData]).then((function(){var e=[];return t.local.tasks().data.each((function(i){if("task"==i.type||!i.type){var r=Object.assign({},i),n=t.local.assignments().data.find((function(t){return t.task==r.id}));r.resources=n.length?n.map((function(t){return t.resource})):null,e.push(r)}}),"",!0),e}))},t.prototype.resourceTaskLoader=function(){var t=this,e=this.app.getService("operations");return webix.promise.all([this.tasksWithResources(),this.local.resources().waitData]).then((function(i){var r=t.getResourceTaskData(i[0]);return r.forEach((function(t){e.setProjectData(t,null,t.data)})),r}))},t.prototype.refreshResourceTree=function(){var t=this;this._resourcesTree.count()?(this.closedResources=[],this._resourcesTree.data.eachChild("0",(function(e){e.open||t.closedResources.push(e.resources)}))):this.closedResources=null,this.resourceTaskLoader().then((function(e){return t._resourcesTree.clearAll(),t._resourcesTree.parse(e),e}))},t.prototype.syncResourceTree=function(){var t=this,e=this._resourcesTree;this.local.tasks().data.attachEvent("onStoreUpdated",(function(i,r,n){if("update"==n){var s=e.exists(i)&&"task"==e.getItem(i).type,a="task"==r.type;if(s&&a){e.updateItem(i,{text:r.text,details:r.details,start_date:r.start_date,end_date:r.end_date,duration:r.duration,progress:r.progress});var o=e.getParentId(i),l=e.getItem(o);return l&&(l=t.app.getService("operations").setProjectData(l,e),e.updateItem(o,l)),!0}s^a&&t.refreshResourceTree()}else t.refreshResourceTree()})),this.local.assignments().data.attachEvent("onStoreUpdated",(function(){t.refreshResourceTree()}))},t.prototype.getResourceTaskData=function(t){var e=this,i=[],r=null,n=this.app.getService("operations");return t.forEach((function(t){var s,a=t.resources;(s=a?i.find((function(t){return pt(t.resources,a)})):r||null)||((s={id:a?webix.uid():"unassigned",type:"project",text:"",data:[],$group:!0,open:e.checkResourceOpen(a)}).resources=a,a&&(s.text=a.map((function(t){return e.local.resources().getItem(t)})).sort(n.sortResources).map((function(t){return t.name})).join(", ")),a?i.push(s):(s.id="unassigned",r=s)),s.data.push(webix.copy(t))})),r&&i.push(r),i},t.prototype.refreshResourceTasks=function(t,e){var i=this,r=this._resourcesTree;if(t){var n=r.getItem(t);e=webix.isUndefined(e)?r.getIndexById(t):e,Q(n,e,this.local.getScales(),this.local.getTaskHeight())}else r.data.order.forEach((function(t,e){i.refreshResourceTasks(t,e)}))},t.prototype.checkResourceOpen=function(t){return!this.closedResources||(t?!this.closedResources.find((function(e){return pt(e,t)})):-1==this.closedResources.indexOf(null))},t}();function Dt(t,e){for(var i=[],r=0;r<e.length;r++)i.push(t(e[r]));return i}function Rt(t,e){for(var i=0,r=0;r<e.length;r++)for(var n=t(e[r]),s=parseInt(e[r].duration),a=n.length-1,o=0;o<n.length;++o){var l=n[o];l&&(i+=(o===a?s:1)*l,s--)}return i}var It=function(t){function e(e){var i=this,n=V({top:0,left:0,selected:null,edit:null,readonly:e.readonly||!1,sort:null,display:e.resources&&"resources"==e.display?"resources":"tasks",criticalPath:e.criticalPath||!1,resourcesDiagram:!(!e.resources||!e.resourcesDiagram),treeWidth:e.treeWidth||(e.resources?400:500)}),s=e.isHoliday||function(t){var e=t.getDay();return 0===e||6===e},a={router:_,version:"9.1.6",debug:!0,start:"/top",compactWidth:650,markers:[{css:"webix_gantt_today_marker",now:!0}],params:{state:n,forceCompact:e.compact},links:!0,isHoliday:s},o=function(t){return i.config.override&&i.config.override.get(t)||t};return(i=t.call(this,r(r({},a),e))||this).setService("local",new(o(kt))(i,e)),i.setService("backend",new(o(St))(i,e.url)),i.setService("operations",new(o(Tt))(i)),i.setService("helpers",new(o($t))(i)),i.setService("grouping",new(o(Ct))(i)),i.use(M,i.config.locale||{lang:"en",webix:{en:"en-US"}}),i}return i(e,t),e.prototype.require=function(t,e){return"jet-views"===t?xt[e]:"jet-locales"===t?Lt[e]:null},e.prototype.getState=function(){return this.config.params.state},e}(y);webix.protoUI({name:"gantt",app:It,getState:function(){return this.$app.getState()},getService:function(t){return this.$app.getService(t)},$init:function(){var t=this,e=this.$app.getState();for(var i in e)j(e,this.config,i);this.$app.attachEvent("bars:beforedrag",(function(e,i){return t.callEvent("onBeforeDrag",[e,i])})),this.$app.attachEvent("bars:beforedrop",(function(e,i){return t.callEvent("onBeforeDrop",[e,i])}))},$exportView:function(t){return"png"===t.export_mode||"pdf"===t.export_mode&&"image"===t.display?this.$app.getRoot():this.$app.getService("local").tasks()}},webix.ui.jetapp);var Ht={Local:kt,Backend:St,Operations:Tt,Helpers:$t,Grouping:Ct},Lt={en:{Edit:"Edit",Done:"Done","Delete task":"Delete task","Delete link":"Delete link","The task will be deleted permanently, are you sure?":"The task will be deleted permanently, are you sure?","The link will be deleted permanently, are you sure?":"The link will be deleted permanently, are you sure?",Predecessors:"Predecessors",Successors:"Successors",Title:"Title","Start date":"Start date","End date":"End date",Duration:"Duration",Progress:"Progress",Notes:"Notes",Type:"Type",Project:"Project",Milestone:"Milestone","Add task":"Add task","Add project":"Add project","(no title)":"(no title)","Save changes?":"Save changes?","Related tasks":"Related tasks",Task:"Task",Link:"Link","End to start":"End to start","Start to start":"Start to start","End to end":"End to end","Start to end":"Start to end",Lasts:"Lasts",day:"day",days:"days","Add assignment":"Add assignment",Assignment:"Assignment",Assignments:"Assignments",Assigned:"Assigned","Delete assignment":"Delete assignment","Are you sure to delete this assignment?":"Are you sure to delete this assignment?","No resources to add":"No resources to add",Unassigned:"Unassigned",hour:"h","Hours per":"Hours per","Tasks per":"Tasks per",Name:"Name",Hours:"Hours",Tasks:"Tasks",month:"month",week:"week",quarter:"quarter",year:"year","Split task":"Split task"}};t.App=It,t.locales=Lt,t.services=Ht,t.views=xt,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=gantt.min.js.map
